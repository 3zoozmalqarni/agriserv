import { useState, useEffect, useMemo } from 'react';
import { Ship, Upload, FileText, AlertCircle, ChevronDown, ChevronUp, Eye, X, Clipboard, Search, Download } from 'lucide-react';
import PageHeader from '../../shared/PageHeader';
import { useVetProcedures } from '../../../hooks/useVetProcedures';
import { useVetImporters } from '../../../hooks/useVetImporters';
import { localDB } from '../../../lib/localDatabase';
import { vetDB, vetDatabase } from '../../../lib/vetDatabase';
import AttachmentsSection from './AttachmentsSection';
import toast from 'react-hot-toast';
import { AnimalData, LabResult, Attachment, requiredTestOptions } from './shipment/shipment-types';

export default function VetAnimalShipment() {
  const { procedures } = useVetProcedures();
  const { importers } = useVetImporters();

  const [procedureNumber, setProcedureNumber] = useState('');
  const [procedureDate, setProcedureDate] = useState('');
  const [transportMethod, setTransportMethod] = useState('');
  const [originCountry, setOriginCountry] = useState('');
  const [selectedImporters, setSelectedImporters] = useState<Array<{name: string, status: string}>>([]);
  const [importerSearch, setImporterSearch] = useState('');
  const [showImporterDropdown, setShowImporterDropdown] = useState(false);
  const [arrivalTime, setArrivalTime] = useState('');

  const [animals, setAnimals] = useState<AnimalData[]>([]);
  const [expandedAnimals, setExpandedAnimals] = useState<Record<number, boolean>>({});

  const [temperatureStatus, setTemperatureStatus] = useState('Ø·Ø¨ÙŠØ¹ÙŠØ©');
  const [temperatureDetails, setTemperatureDetails] = useState('');

  const [diseaseSymptoms, setDiseaseSymptoms] = useState('Ù„Ø§ ÙŠÙˆØ¬Ø¯');
  const [diseaseSymptomsDetails, setDiseaseSymptomsDetails] = useState('');

  const [skeletonSymptoms, setSkeletonSymptoms] = useState('Ù„Ø§ ÙŠÙˆØ¬Ø¯');
  const [skeletonSymptomsDetails, setSkeletonSymptomsDetails] = useState('');

  const [skinSymptoms, setSkinSymptoms] = useState('Ù„Ø§ ÙŠÙˆØ¬Ø¯');
  const [skinSymptomsDetails, setSkinSymptomsDetails] = useState('');

  const [anatomicalFeatures, setAnatomicalFeatures] = useState('Ù„Ø§ ÙŠÙˆØ¬Ø¯');
  const [anatomicalFeaturesDetails, setAnatomicalFeaturesDetails] = useState('');

  const [generalDiagnosis, setGeneralDiagnosis] = useState('Ø³Ù„ÙŠÙ…');
  const [generalDiagnosisCustom, setGeneralDiagnosisCustom] = useState('');
  const [finalAction, setFinalAction] = useState('');
  const [finalDecision, setFinalDecision] = useState('');
  const [autoGeneratedDecision, setAutoGeneratedDecision] = useState('');
  const [labResults, setLabResults] = useState<LabResult[]>([]);
  const [doctors, setDoctors] = useState<string[]>([]);
  const [showResultsModal, setShowResultsModal] = useState(false);
  const [printContent, setPrintContent] = useState<any>(null);
  const [isDataImported, setIsDataImported] = useState(false);
  const [attachments, setAttachments] = useState<Attachment[]>([]);
  const [showSuccessModal, setShowSuccessModal] = useState(false);

  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as HTMLElement;
      if (showImporterDropdown && !target.closest('.relative')) {
        setShowImporterDropdown(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [showImporterDropdown]);

  // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  useEffect(() => {
    const handleResultsUpdate = () => {
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø­Ù…Ù„
      if (procedureNumber && isDataImported) {
        loadLabResults(procedureNumber);
      }
    };

    window.addEventListener('results-data-changed', handleResultsUpdate);
    return () => {
      window.removeEventListener('results-data-changed', handleResultsUpdate);
    };
  }, [procedureNumber, isDataImported]);

  const handleImportData = async () => {
    if (!procedureNumber.trim()) {
      toast.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ');
      return;
    }

    const searchProcedureNumber = procedureNumber.trim();
    console.log(`[VetShipment] ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ø±Ù‚Ù…: ${searchProcedureNumber}`);
    console.log(`[VetShipment] Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: ${procedures.length}`);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ÙŠØ§Øª
    const existingShipments = await vetDB.getAnimalShipments();
    console.log(`[VetShipment] Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©: ${existingShipments.length}`);

    const isAlreadyRegistered = existingShipments.some(
      shipment => shipment.procedure_number === searchProcedureNumber
    );

    if (isAlreadyRegistered) {
      toast.error('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹', {
        duration: 4000,
        icon: 'âš ï¸',
        style: {
          background: '#FEE2E2',
          color: '#991B1B',
          fontSize: '16px',
          fontWeight: 'bold',
          padding: '16px',
          borderRadius: '8px',
          border: '2px solid #DC2626'
        }
      });
      return;
    }

    const procedure = procedures.find(p => p.procedure_number === searchProcedureNumber);

    if (!procedure) {
      console.log(`[VetShipment] âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ø±Ù‚Ù…: ${searchProcedureNumber}`);
      console.log('[VetShipment] Ù‚Ø§Ø¦Ù…Ø© Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:', procedures.map(p => p.procedure_number));
      toast.error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…');
      return;
    }

    console.log('ğŸ” Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯:', procedure);
    console.log('ğŸ“‹ receiver_name:', procedure.receiver_name);
    console.log('ğŸ‘¥ sampling_doctors:', procedure.sampling_doctors);

    setTransportMethod(procedure.client_name);
    setOriginCountry(procedure.country_port);
    setProcedureDate(procedure.reception_date);

    const animalData: AnimalData[] = procedure.sample_groups.map(group => ({
      animal_type: group.animal_type,
      animal_gender: group.animal_gender,
      animal_count: '',
      death_count: '',
      final_decision: '',
      quarantine_locations: [],
      quarantine_traders: [],
      return_category: '',
      return_reason: ''
    }));

    setAnimals(animalData);

    // Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡: Ù…Ø¹Ø¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø£Ø·Ø¨Ø§Ø¡ Ø³Ø­Ø¨ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª
    const allDoctors: string[] = [];

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ Ø£ÙˆÙ„Ø§Ù‹
    if (procedure.receiver_name) {
      console.log('âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:', procedure.receiver_name);
      allDoctors.push(procedure.receiver_name);
    } else {
      console.log('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ receiver_name ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!');
    }

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…ÙŠÙ† Ø¨Ø§Ù„ÙƒØ´Ù ÙˆØ³Ø­Ø¨ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª
    if (procedure.sampling_doctors && procedure.sampling_doctors.length > 0) {
      console.log('âœ… Ø¥Ø¶Ø§ÙØ© Ø£Ø·Ø¨Ø§Ø¡ Ø³Ø­Ø¨ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª:', procedure.sampling_doctors);
      procedure.sampling_doctors.forEach(doctor => {
        if (!allDoctors.includes(doctor)) {
          allDoctors.push(doctor);
        }
      });
    } else {
      console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ sampling_doctors ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!');
    }

    console.log('ğŸ‘¨â€âš•ï¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:', allDoctors);
    setDoctors(allDoctors);

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    await loadLabResults(searchProcedureNumber, procedure);

    setIsDataImported(true);
    toast.success('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
  };

  const loadLabResults = async (procNumber: string, proc?: any) => {
    try {
      console.log('ğŸ” Loading lab results for procedure:', procNumber);

      // Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª
      const savedSamples = await localDB.getAllSavedSamplesWithSamples();
      console.log('ğŸ“‹ All saved samples:', savedSamples.length);
      console.log('ğŸ” Looking for external_procedure_number:', procNumber);
      const procedure = savedSamples.find(p => p.external_procedure_number === procNumber);

      if (!procedure) {
        console.log('âŒ Procedure not found in local database');
        // Ø¥Ø°Ø§ ØªÙ… ØªÙ…Ø±ÙŠØ± procedure Ù…Ù† Ø§Ù„Ø®Ø§Ø±Ø¬ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        if (proc) {
          console.log('âš ï¸ Using procedure from parameter, but no samples found');
          setLabResults([]);
          setPrintContent({
            type: 'procedure',
            procedure: proc,
            samples: []
          });
          return;
        }
        // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙˆÙ„Ø§ Ù†ØºÙŠØ± printContent Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„
        console.log('âš ï¸ No procedure found, keeping existing state');
        if (!printContent) {
          setLabResults([]);
        }
        return;
      }

      console.log('âœ… Procedure found:', procedure);

      if (!procedure.samples || procedure.samples.length === 0) {
        console.log('âŒ Procedure has no samples');
        setLabResults([]);
        setPrintContent({
          type: 'procedure',
          procedure: procedure,
          samples: []
        });
        return;
      }

      console.log('ğŸ“¦ Samples count:', procedure.samples.length);

      // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
      const allLocalResults = await localDB.getTestResults();
      console.log('ğŸ§ª All local test results:', allLocalResults.length);

      // Ø±Ø¨Ø· Ø§Ù„Ø¹ÙŠÙ†Ø§Øª Ù…Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙ‚Ø·
      const samplesWithResults = (procedure.samples || []).map((sample: any) => {
        const localResult = allLocalResults.find(r => r.sample_id === sample.id && r.approval_status === 'approved');
        if (localResult) {
          console.log('âœ… Found approved result for sample:', sample.sample_number);
          console.log('ğŸ“‹ Result data:', {
            confirmed_positive_samples: localResult.confirmed_positive_samples,
            confirmatory_test_method: localResult.confirmatory_test_method
          });
        }
        return { sample, result: localResult };
      }).filter((item: any) => item.result); // ÙÙ‚Ø· Ø§Ù„Ø¹ÙŠÙ†Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ Ù†ØªØ§Ø¦Ø¬ Ù…Ø¹ØªÙ…Ø¯Ø©

      console.log('ğŸ“Š Samples with results:', samplesWithResults.length);

      if (samplesWithResults.length === 0) {
        console.log('âš ï¸ No approved results found yet');
        toast('Ù„Ù… ÙŠØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø®ØªØ¨Ø±ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ø¹Ø¯', {
          icon: 'â³',
          duration: 4000
        });
      }

      setLabResults(samplesWithResults as any);

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
      setPrintContent({
        type: 'procedure',
        procedure: procedure,
        samples: samplesWithResults
      });

      console.log('âœ… Print content prepared');
    } catch (error) {
      console.error('âŒ Error loading lab results:', error);
      toast.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬');
      setLabResults([]);
      setPrintContent(null);
    }
  };

  const handleShowResults = async () => {
    if (!procedureNumber.trim()) {
      toast.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹');
      return;
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ printContentØŒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    if (!printContent) {
      await loadLabResults(procedureNumber);
    }

    setShowResultsModal(true);
  };

  const getResultLabel = (testResult: string) => {
    switch (testResult) {
      case 'positive':
        return 'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ';
      case 'negative':
        return 'Ø³Ù„Ø¨ÙŠ';
      case 'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯':
        return 'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯';
      case 'Ø³Ù„Ø¨ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯':
        return 'Ø³Ù„Ø¨ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯';
      case 'vaccination_efficacy':
        return 'ÙƒÙØ§Ø¡Ø© ØªØ­ØµÙŠÙ†';
      case 'Ø§Ø®ØªØ¨Ø§Ø± ÙƒÙØ§Ø¡Ø© ØªØ­ØµÙŠÙ†':
        return 'Ø§Ø®ØªØ¨Ø§Ø± ÙƒÙØ§Ø¡Ø© ØªØ­ØµÙŠÙ†';
      case 'ÙƒÙØ§Ø¡Ø© ØªØ­ØµÙŠÙ†':
        return 'ÙƒÙØ§Ø¡Ø© ØªØ­ØµÙŠÙ†';
      default:
        return testResult;
    }
  };

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©
  const areAllResultsComplete = useMemo(() => {
    if (!printContent?.procedure || !printContent?.procedure?.samples) {
      return false;
    }

    const totalSamples = printContent.procedure.samples.length;
    const samplesWithResults = labResults.length;

    return totalSamples > 0 && totalSamples === samplesWithResults;
  }, [printContent, labResults]);

  const handlePasteFromClipboard = async () => {
    try {
      const text = await navigator.clipboard.readText();
      if (text && text.trim()) {
        setProcedureNumber(text.trim());
        toast.success('ØªÙ… Ø§Ù„Ù„ØµÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
      } else {
        toast.error('Ø§Ù„Ø­Ø§ÙØ¸Ø© ÙØ§Ø±ØºØ©');
      }
    } catch (error) {
      console.error('Clipboard error:', error);
      toast.error('ÙØ´Ù„ Ø§Ù„Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ctrl+V Ø£Ùˆ Command+V Ù„Ù„ØµÙ‚', {
        duration: 4000
      });
    }
  };

  const updateAnimalField = (index: number, field: keyof AnimalData, value: string) => {
    const newAnimals = [...animals];
    newAnimals[index] = { ...newAnimals[index], [field]: value };

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø±Ø§Ø±
    if (field === 'final_decision') {
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø¬Ø± ÙˆÙØ¦Ø© ÙˆØ³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
      newAnimals[index].quarantine_locations = [];
      newAnimals[index].quarantine_traders = [];
      newAnimals[index].return_category = '';
      newAnimals[index].return_reason = '';
      calculateFinalDecision(newAnimals);
    }

    setAnimals(newAnimals);
  };

  // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø­Ø¬Ø± (checkboxes)
  const toggleQuarantineLocation = (index: number, location: string) => {
    const newAnimals = [...animals];
    const currentLocations = newAnimals[index].quarantine_locations || [];

    if (currentLocations.includes(location)) {
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­Ø¯Ø¯Ø§Ù‹
      newAnimals[index].quarantine_locations = currentLocations.filter(loc => loc !== location);
    } else {
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­Ø¯Ø¯Ø§Ù‹
      newAnimals[index].quarantine_locations = [...currentLocations, location];
    }

    setAnimals(newAnimals);
  };

  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª
  const calculateFinalDecision = (animalsData: AnimalData[]) => {
    const decisions = animalsData
      .filter(a => a.final_decision && a.final_decision.trim())
      .map(a => a.final_decision);

    if (decisions.length === 0) {
      setAutoGeneratedDecision('');
      setFinalDecision('');
      return;
    }

    const hasFaseh = decisions.includes('ÙØ³Ø­');
    const hasHajar = decisions.includes('Ø­Ø¬Ø±');
    const hasIrjaa = decisions.includes('Ø¥Ø±Ø¬Ø§Ø¹');

    let decision = '';

    // ÙƒÙ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙØ³Ø­
    if (hasFaseh && !hasHajar && !hasIrjaa) {
      decision = 'ÙØ³Ø­';
    }
    // ÙƒÙ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø­Ø¬Ø±
    else if (!hasFaseh && hasHajar && !hasIrjaa) {
      decision = 'Ø­Ø¬Ø±';
    }
    // ÙƒÙ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø¥Ø±Ø¬Ø§Ø¹
    else if (!hasFaseh && !hasHajar && hasIrjaa) {
      decision = 'Ø¥Ø±Ø¬Ø§Ø¹';
    }
    // ÙØ³Ø­ ÙˆØ­Ø¬Ø±
    else if (hasFaseh && hasHajar && !hasIrjaa) {
      decision = 'Ø­Ø¬Ø± Ø¬Ø²Ø¦ÙŠ';
    }
    // ÙØ³Ø­ ÙˆØ¥Ø±Ø¬Ø§Ø¹
    else if (hasFaseh && !hasHajar && hasIrjaa) {
      decision = 'Ø¥Ø±Ø¬Ø§Ø¹ Ø¬Ø²Ø¦ÙŠ';
    }
    // Ø­Ø¬Ø± ÙˆØ¥Ø±Ø¬Ø§Ø¹
    else if (!hasFaseh && hasHajar && hasIrjaa) {
      decision = 'Ø­Ø¬Ø± - Ø¥Ø±Ø¬Ø§Ø¹ Ø¬Ø²Ø¦ÙŠ';
    }
    // ÙØ³Ø­ ÙˆØ­Ø¬Ø± ÙˆØ¥Ø±Ø¬Ø§Ø¹
    else if (hasFaseh && hasHajar && hasIrjaa) {
      decision = 'Ø­Ø¬Ø± Ø¬Ø²Ø¦ÙŠ - Ø¥Ø±Ø¬Ø§Ø¹ Ø¬Ø²Ø¦ÙŠ';
    }

    setAutoGeneratedDecision(decision);
    setFinalDecision(decision);
  };

  const toggleAnimal = (index: number) => {
    setExpandedAnimals(prev => ({
      ...prev,
      [index]: !prev[index]
    }));
  };

  // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù‚Ø±Ø§Ø±)
  const isAnimalBasicDataValid = (animal: AnimalData): boolean => {
    return !!(
      animal.animal_type &&
      animal.animal_type.trim() &&
      animal.animal_gender &&
      animal.animal_gender.trim() &&
      animal.animal_count !== undefined &&
      animal.animal_count !== '' &&
      animal.death_count !== undefined &&
      animal.death_count !== ''
    );
  };

  // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ù…Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø±)
  const isAnimalValid = (animal: AnimalData): boolean => {
    const hasBasicData = isAnimalBasicDataValid(animal);
    const hasDecision = animal.final_decision && animal.final_decision.trim();

    if (!hasBasicData || !hasDecision) return false;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø¬Ø± Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø¬Ø± (ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)
    if (animal.final_decision === 'Ø­Ø¬Ø±') {
      const hasQuarantineLocation = !!(animal.quarantine_locations && animal.quarantine_locations.length > 0);

      // Ø¥Ø°Ø§ ÙƒØ§Ù† "Ø­Ø¬Ø± ÙÙŠ Ø§Ù„Ø®Ù…Ø±Ø©" Ù…Ø®ØªØ§Ø±Ø§Ù‹ØŒ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø¬Ø± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
      if (animal.quarantine_locations?.includes('Ø­Ø¬Ø± ÙÙŠ Ø§Ù„Ø®Ù…Ø±Ø©')) {
        return hasQuarantineLocation && !!(animal.quarantine_traders && animal.quarantine_traders.length > 0);
      }

      return hasQuarantineLocation;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø±Ø¬Ø§Ø¹
    if (animal.final_decision === 'Ø¥Ø±Ø¬Ø§Ø¹') {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¨Ø¨
      if (!animal.return_type || !animal.return_type.trim()) return false;

      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¨Ø¨ Ù…Ø±Ø¶ÙŠ
      if (animal.return_type === 'Ù…Ø±Ø¶ÙŠØ©') {
        return !!(animal.return_category && animal.return_category.trim() && animal.return_reason && animal.return_reason.trim());
      }

      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¨Ø¨ Ø¥Ø¯Ø§Ø±ÙŠ
      if (animal.return_type === 'Ø¥Ø¯Ø§Ø±ÙŠØ©') {
        if (!animal.admin_return_reasons || animal.admin_return_reasons.length === 0) return false;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ù…ÙƒØªÙ…Ù„Ø©
        return animal.admin_return_reasons.every((reason: any) => {
          if (!reason.type || !reason.type.trim()) return false;
          if (reason.type === 'Ø£Ø®Ø±Ù‰') {
            return !!(reason.customText && reason.customText.trim());
          }
          return true;
        });
      }

      return false;
    }

    return true;
  };

  // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ÙŠØ©
  const isShipmentDataValid = (): boolean => {
    return !!(
      procedureNumber &&
      procedureNumber.trim() &&
      procedureDate &&
      procedureDate.trim() &&
      transportMethod &&
      transportMethod.trim() &&
      originCountry &&
      originCountry.trim() &&
      selectedImporters.length > 0 &&
      arrivalTime &&
      arrivalTime.trim()
    );
  };

  // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·)
  const areAnimalsValid = (): boolean => {
    if (animals.length === 0) return false;
    return animals.every(animal => isAnimalBasicDataValid(animal));
  };

  // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©
  const areLabReportsAvailable = (): boolean => {
    return !!(printContent?.procedure && labResults.length > 0);
  };

  // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
  const isFinalActionValid = (): boolean => {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Øµ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ£Ù† ÙƒÙ„ Ø­ÙŠÙˆØ§Ù† Ù„Ù‡ Ù‚Ø±Ø§Ø±
    const allAnimalsHaveDecisions = animals.length > 0 && animals.every(animal =>
      animal.final_decision && animal.final_decision.trim()
    );
    return !!(
      finalAction &&
      finalAction.trim() &&
      finalDecision &&
      finalDecision.trim() &&
      allAnimalsHaveDecisions
    );
  };

  // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡
  const areDoctorsAvailable = (): boolean => {
    return doctors.length > 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    if (!procedureNumber.trim()) {
      toast.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ');
      return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
    const existingShipments = await vetDB.getAnimalShipments();
    const isAlreadyRegistered = existingShipments.some(
      shipment => shipment.procedure_number === procedureNumber
    );

    if (isAlreadyRegistered) {
      toast.error('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', {
        duration: 4000,
        icon: 'âš ï¸',
        style: {
          background: '#FEE2E2',
          color: '#991B1B',
          fontSize: '16px',
          fontWeight: 'bold',
          padding: '16px',
          borderRadius: '8px',
          border: '2px solid #DC2626'
        }
      });
      return;
    }

    if (!transportMethod.trim()) {
      toast.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù†Ù‚Ù„');
      return;
    }

    if (!originCountry.trim()) {
      toast.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ù„Ø¯ Ø§Ù„Ù…Ù†Ø´Ø£');
      return;
    }

    if (selectedImporters.length === 0) {
      toast.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆØ±Ø¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
      return;
    }

    if (!arrivalTime.trim()) {
      toast.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„');
      return;
    }

    if (animals.length === 0) {
      toast.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª');
      return;
    }

    if (doctors.length === 0) {
      toast.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø·Ø¨ÙŠØ¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
      return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©
    if (!printContent?.procedure || labResults.length === 0) {
      toast.error('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ÙØ¸ Ù‚Ø¨Ù„ Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©', {
        duration: 4000,
        icon: 'ğŸ”¬',
        style: {
          background: '#FEF3C7',
          color: '#92400E',
          fontSize: '16px',
          fontWeight: 'bold',
          padding: '16px',
          borderRadius: '8px',
          border: '2px solid #F59E0B'
        }
      });
      return;
    }

    if (!areAllResultsComplete) {
      const totalSamples = printContent.procedure.samples?.length || 0;
      const completedResults = labResults.length;

      toast.error(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ÙØ¸ Ù‚Ø¨Ù„ Ø§ÙƒØªÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©\n(${completedResults} Ù…Ù† ${totalSamples} Ù†ØªÙŠØ¬Ø©)`, {
        duration: 5000,
        icon: 'âš ï¸',
        style: {
          background: '#FEF3C7',
          color: '#92400E',
          fontSize: '16px',
          fontWeight: 'bold',
          padding: '16px',
          borderRadius: '8px',
          border: '2px solid #F59E0B',
          whiteSpace: 'pre-line'
        }
      });
      return;
    }


    try {
      await vetDB.createAnimalShipment({
        procedure_number: procedureNumber,
        procedure_date: procedureDate,
        transport_method: transportMethod,
        origin_country: originCountry,
        importer_name: selectedImporters.map(imp => imp.name).join(' | '),
        arrival_time: arrivalTime,
        animals: animals,
        temperature_status: temperatureStatus,
        temperature_details: temperatureDetails,
        disease_symptoms: diseaseSymptoms,
        disease_symptoms_details: diseaseSymptomsDetails,
        skeleton_symptoms: skeletonSymptoms,
        skeleton_symptoms_details: skeletonSymptomsDetails,
        skin_symptoms: skinSymptoms,
        skin_symptoms_details: skinSymptomsDetails,
        anatomical_features: anatomicalFeatures,
        anatomical_features_details: anatomicalFeaturesDetails,
        general_diagnosis: generalDiagnosis === 'Ø£Ø®Ø±Ù‰' ? generalDiagnosisCustom : generalDiagnosis,
        final_action: finalAction,
        final_decision: finalDecision,
        doctors: doctors,
        attachments: attachments,
        created_by: null
      });

      // Ø¥Ø·Ù„Ø§Ù‚ Ø­Ø¯Ø« Ù„ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªØªØ¨Ø¹
      window.dispatchEvent(new Event('shipment-data-changed'));

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      setProcedureNumber('');
      setProcedureDate('');
      setTransportMethod('');
      setOriginCountry('');
      setSelectedImporters([]);
      setImporterSearch('');
      setArrivalTime('');
      setAnimals([]);
      setTemperatureStatus('Ø·Ø¨ÙŠØ¹ÙŠØ©');
      setTemperatureDetails('');
      setDiseaseSymptoms('Ù„Ø§ ÙŠÙˆØ¬Ø¯');
      setDiseaseSymptomsDetails('');
      setSkeletonSymptoms('Ù„Ø§ ÙŠÙˆØ¬Ø¯');
      setSkeletonSymptomsDetails('');
      setSkinSymptoms('Ù„Ø§ ÙŠÙˆØ¬Ø¯');
      setSkinSymptomsDetails('');
      setAnatomicalFeatures('Ù„Ø§ ÙŠÙˆØ¬Ø¯');
      setAnatomicalFeaturesDetails('');
      setGeneralDiagnosis('Ø³Ù„ÙŠÙ…');
      setGeneralDiagnosisCustom('');
      setFinalAction('');
      setFinalDecision('');
      setAutoGeneratedDecision('');
      setDoctors([]);
      setAttachments([]);
      setIsDataImported(false);

      // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      setTimeout(() => {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ scroll
        const mainContent = document.querySelector('main');
        if (mainContent) {
          mainContent.scrollTo({ top: 0, behavior: 'smooth' });
        }
        // Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù„Ù‰ window Ø£ÙŠØ¶Ø§Ù‹
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, 100);

      // Ø¹Ø±Ø¶ modal Ø§Ù„Ù†Ø¬Ø§Ø­
      setShowSuccessModal(true);
    } catch (error) {
      console.error('Error saving shipment:', error);
      toast.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  };

  return (
    <div className="min-h-0 bg-slate-50 p-6">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 p-8">
          <PageHeader
            icon={Ship}
            title="ØªØ³Ø¬ÙŠÙ„ Ø¥Ø±Ø³Ø§Ù„ÙŠØ© Ø­ÙŠÙˆØ§Ù†ÙŠØ©"
            subtitle="ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†ÙŠØ©"
          />

          <form onSubmit={handleSubmit} className="space-y-8">
            {/* Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */}
            <div className={`rounded-xl p-6 border transition-all ${
              !isShipmentDataValid() ? 'bg-gradient-to-br from-red-50 to-red-50/50 border-red-300' : 'bg-gradient-to-br from-[#003361]/5 to-[#004d8c]/5 border-[#003361]/20'
            }`}>
              <div className="flex items-center gap-3 mb-6 border-b pb-3" style={{ borderColor: !isShipmentDataValid() ? '#dc2626' : 'rgba(0, 51, 97, 0.3)' }}>
                <h3 className={`text-xl font-bold ${!isShipmentDataValid() ? 'text-red-700' : 'text-gray-800'}`}>
                  Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                </h3>
                {!isShipmentDataValid() && (
                  <span className="flex items-center gap-1 text-xs font-semibold text-red-600 bg-red-100 px-3 py-1.5 rounded-full">
                    <AlertCircle className="w-4 h-4" />
                    Ø­Ù‚ÙˆÙ„ Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù…ÙÙ‚ÙˆØ¯Ø©
                  </span>
                )}
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="md:col-span-2">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ <span className="text-red-600">*</span>
                  </label>
                  <div className="flex gap-3">
                    <div className="flex-1 relative">
                      <input
                        type="text"
                        value={procedureNumber}
                        onChange={(e) => !isDataImported && setProcedureNumber(e.target.value)}
                        readOnly={isDataImported}
                        required
                        className="w-full px-4 pr-12 h-[50px] border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent"
                        style={isDataImported ? { backgroundColor: '#f3f4f6', cursor: 'not-allowed' } : {}}
                        placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ"
                      />
                      {!isDataImported && (
                        <button
                          type="button"
                          onClick={handlePasteFromClipboard}
                          className="absolute left-3 top-1/2 -translate-y-1/2 p-2 text-gray-500 hover:text-[#f18700] hover:bg-gray-100 rounded transition-all duration-200"
                          title="Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©"
                        >
                          <Clipboard className="w-5 h-5" />
                        </button>
                      )}
                    </div>
                    <button
                      type="button"
                      onClick={handleImportData}
                      disabled={isDataImported}
                      className={`flex items-center gap-2 px-6 py-2.5 rounded-lg transition-all duration-300 font-semibold shadow-md ${
                        isDataImported
                          ? 'bg-gray-400 cursor-not-allowed opacity-60'
                          : 'bg-gradient-to-r from-amber-600 to-amber-700 text-white hover:from-amber-700 hover:to-amber-800 hover:shadow-lg'
                      }`}
                    >
                      <Download className="w-5 h-5" />
                      Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Ø§Ù„ØªØ§Ø±ÙŠØ® <span className="text-red-600">*</span>
                  </label>
                  <input
                    type="text"
                    value={procedureDate}
                    readOnly
                    required
                    className="w-full px-4 h-[50px] border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"
                    placeholder="Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ù†Ù‚Ù„ <span className="text-red-600">*</span>
                  </label>
                  <input
                    type="text"
                    value={transportMethod}
                    readOnly
                    required
                    className="w-full px-4 h-[50px] border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"
                    placeholder="Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Ø¨Ù„Ø¯ Ø§Ù„Ù…Ù†Ø´Ø£ <span className="text-red-600">*</span>
                  </label>
                  <input
                    type="text"
                    value={originCountry}
                    readOnly
                    required
                    className="w-full px-4 h-[50px] border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"
                    placeholder="Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„ <span className="text-red-600">*</span>
                  </label>
                  <select
                    value={arrivalTime}
                    onChange={(e) => setArrivalTime(e.target.value)}
                    required
                    className="w-full px-4 h-[50px] border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent"
                  >
                    <option value="">Ø§Ø®ØªØ± ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„</option>
                    <option value="ØµØ¨Ø§Ø­Ø§Ù‹">ØµØ¨Ø§Ø­Ø§Ù‹</option>
                    <option value="Ù…Ø³Ø§Ø¡Ù‹">Ù…Ø³Ø§Ø¡Ù‹</option>
                    <option value="Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„">Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„</option>
                  </select>
                </div>

                <div className="relative md:col-span-2">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯ÙŠÙ† <span className="text-red-600">*</span>
                  </label>

                  {selectedImporters.length > 0 && (
                    <div className="flex flex-wrap gap-2 mb-3">
                      {selectedImporters.map((importer, index) => {
                        const isActive = importer.status === 'Ù†Ø´Ø·';
                        return (
                          <div
                            key={index}
                            className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border ${
                              isActive
                                ? 'bg-green-100 text-green-800 border-green-400'
                                : 'bg-red-100 text-red-800 border-red-400'
                            }`}
                          >
                            <span className="font-semibold text-sm">{importer.name}</span>
                            <button
                              type="button"
                              onClick={() => {
                                setSelectedImporters(prev => prev.filter((_, i) => i !== index));
                              }}
                              className="hover:bg-white/40 rounded-full p-0.5 transition-colors"
                            >
                              <X className="w-4 h-4" />
                            </button>
                          </div>
                        );
                      })}
                    </div>
                  )}

                  <div className="relative">
                    <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                      <Search className="w-5 h-5 text-gray-400" />
                    </div>
                    <input
                      type="text"
                      value={importerSearch}
                      onChange={(e) => {
                        setImporterSearch(e.target.value);
                        setShowImporterDropdown(true);
                      }}
                      onFocus={() => setShowImporterDropdown(true)}
                      className="w-full px-4 pr-11 h-[50px] border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent"
                      placeholder="Ø§Ø¨Ø­Ø« ÙˆØ£Ø¶Ù Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯ÙŠÙ†..."
                    />
                  </div>
                  {showImporterDropdown && (
                    <div className="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                      {importers
                        .filter(imp =>
                          !selectedImporters.some(si => si.name === imp.importer_name) &&
                          (imp.importer_name.toLowerCase().includes(importerSearch.toLowerCase()) ||
                           (imp.farm_location || '').toLowerCase().includes(importerSearch.toLowerCase()))
                        )
                        .map(importer => {
                          const isActive = importer.status === 'Ù†Ø´Ø·';
                          return (
                            <div
                              key={importer.id}
                              onClick={() => {
                                setSelectedImporters(prev => [...prev, { name: importer.importer_name, status: importer.status }]);
                                setImporterSearch('');
                              }}
                              className={`px-4 py-3 cursor-pointer transition-colors border-b border-gray-100 last:border-b-0 ${
                                isActive
                                  ? 'hover:bg-green-50 bg-green-50/30'
                                  : 'hover:bg-red-50 bg-red-50/30'
                              }`}
                            >
                              <div className="flex items-center gap-2">
                                <div className={`font-semibold ${isActive ? 'text-green-700' : 'text-red-700'}`}>
                                  {importer.importer_name}
                                </div>
                                <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${
                                  isActive
                                    ? 'bg-green-100 text-green-700'
                                    : 'bg-red-100 text-red-700'
                                }`}>
                                  {importer.status}
                                </span>
                              </div>
                              {importer.farm_location && (
                                <div className={`text-sm mt-0.5 ${isActive ? 'text-green-600' : 'text-red-600'}`}>
                                  {importer.farm_location}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      {importers.filter(imp =>
                        !selectedImporters.some(si => si.name === imp.importer_name) &&
                        (imp.importer_name.toLowerCase().includes(importerSearch.toLowerCase()) ||
                         (imp.farm_location || '').toLowerCase().includes(importerSearch.toLowerCase()))
                      ).length === 0 && (
                        <div className="px-4 py-3 text-gray-500 text-center">
                          {selectedImporters.length > 0 && importerSearch === '' ? 'Ø§Ø¨Ø­Ø« Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯...' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬'}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ÙŠØ© */}
            <div className={`rounded-xl p-6 border transition-all ${
              !areAnimalsValid() ? 'bg-gradient-to-br from-red-50 to-red-50/50 border-red-300' : 'bg-gradient-to-br from-[#61bf69]/10 to-[#50a857]/10 border-[#61bf69]/30'
            }`}>
              <div className="flex items-center justify-between mb-6 border-b pb-3" style={{ borderColor: !areAnimalsValid() ? '#dc2626' : 'rgba(97, 191, 105, 0.4)' }}>
                <div className="flex items-center gap-3">
                  <h3 className={`text-xl font-bold ${!areAnimalsValid() ? 'text-red-700' : 'text-gray-800'}`}>
                    Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ÙŠØ©
                  </h3>
                  {!areAnimalsValid() && animals.length > 0 && (
                    <span className="flex items-center gap-1 text-xs font-semibold text-red-600 bg-red-100 px-3 py-1.5 rounded-full">
                      <AlertCircle className="w-4 h-4" />
                      Ø­Ù‚ÙˆÙ„ Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù…ÙÙ‚ÙˆØ¯Ø©
                    </span>
                  )}
                </div>
                {isDataImported && (
                  <span className="text-xs bg-[#61bf69]/20 text-[#003361] px-3 py-1 rounded-full font-semibold">
                    ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
                  </span>
                )}
              </div>

              {animals.length === 0 ? (
                <div className="text-center py-8 bg-white/60 rounded-lg border border-[#61bf69]/30">
                  <AlertCircle className="w-12 h-12 text-gray-400 mx-auto mb-3" />
                  <p className="text-gray-500">Ù‚Ù… Ø¨Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {animals.map((animal, index) => {
                    const isValid = isAnimalBasicDataValid(animal);
                    return (
                    <div key={index} className={`bg-white/60 rounded-lg border-2 overflow-hidden transition-all ${
                      !isValid ? 'border-red-400 shadow-red-200 shadow-lg' : 'border-[#61bf69]/30'
                    }`}>
                      <button
                        type="button"
                        onClick={() => toggleAnimal(index)}
                        className={`w-full flex items-center justify-between p-4 hover:bg-white/80 transition-colors ${
                          !isValid ? 'bg-red-50/50' : ''
                        }`}
                      >
                        <div className="flex items-center gap-3">
                          <span className={`text-lg font-bold ${!isValid ? 'text-red-700' : 'text-gray-800'}`}>
                            Ø§Ù„Ø­ÙŠÙˆØ§Ù† {index + 1}
                          </span>
                          {!isValid && (
                            <span className="flex items-center gap-1 text-xs font-semibold text-red-600 bg-red-100 px-3 py-1 rounded-full">
                              <AlertCircle className="w-4 h-4" />
                              Ø­Ù‚ÙˆÙ„ Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù…ÙÙ‚ÙˆØ¯Ø©
                            </span>
                          )}
                          <span className="text-sm text-gray-600">
                            {animal.animal_type && `(${animal.animal_type} - ${animal.animal_gender})`}
                          </span>
                        </div>
                        {expandedAnimals[index] ? (
                          <ChevronUp className="w-5 h-5 text-gray-500" />
                        ) : (
                          <ChevronDown className="w-5 h-5 text-gray-500" />
                        )}
                      </button>

                      {expandedAnimals[index] && (
                        <div className="p-5 border-t border-[#61bf69]/30 bg-white/40">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-2">
                                Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù† <span className="text-red-600">*</span>
                              </label>
                              <input
                                type="text"
                                value={animal.animal_type}
                                readOnly
                                className="w-full px-4 h-[50px] border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"
                                placeholder="Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
                              />
                            </div>

                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-2">
                                Ø¬Ù†Ø³ Ø§Ù„Ø­ÙŠÙˆØ§Ù† <span className="text-red-600">*</span>
                              </label>
                              <input
                                type="text"
                                value={animal.animal_gender}
                                readOnly
                                className="w-full px-4 h-[50px] border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"
                                placeholder="Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
                              />
                            </div>

                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-2">
                                Ø¹Ø¯Ø¯ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª <span className="text-red-600">*</span>
                              </label>
                              <input
                                type="number"
                                value={animal.animal_count}
                                onChange={(e) => updateAnimalField(index, 'animal_count', e.target.value)}
                                min="0"
                                className="w-full px-4 h-[50px] border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent"
                                placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª"
                              />
                            </div>

                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-2">
                                Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙÙˆÙ‚ <span className="text-red-600">*</span>
                              </label>
                              <input
                                type="number"
                                value={animal.death_count}
                                onChange={(e) => updateAnimalField(index, 'death_count', e.target.value)}
                                min="0"
                                className="w-full px-4 h-[50px] border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent"
                                placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙÙˆÙ‚"
                              />
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø¸Ø§Ù‡Ø±ÙŠ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ÙŠØ© */}
            <div className="bg-gradient-to-br from-[#003361]/5 to-[#61bf69]/5 rounded-xl p-6 border border-[#003361]/20">
              <h3 className="text-xl font-bold text-gray-800 mb-4 border-b border-[#003361]/30 pb-3">
                ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø¸Ø§Ù‡Ø±ÙŠ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ÙŠØ©
              </h3>

              <p className="text-lg font-bold text-gray-800 mb-4 leading-relaxed">
                Ø¨Ø¹Ø¯ Ø§Ù„ÙƒØ´Ù Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„Ø¹Ù†Ø§Ø¨Ø± ÙÙŠ Ø§Ù„Ø¨Ø§Ø®Ø±Ø© ÙˆØ¹Ø²Ù„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ´ØªØ¨Ù‡ Ø¨Ø¥ØµØ§Ø¨ØªÙ‡Ø§ Ø¨Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ "ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯Ù‡Ø§" Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø¯Ù†Ø§Ù‡ ØªÙˆØ¶Ø­ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ÙŠØ©
              </p>

              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">
                    Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© / Ø§Ù„Ø£ØºØ´ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ø·ÙŠØ© <span className="text-red-600">*</span>
                  </label>
                  <select
                    value={temperatureStatus}
                    onChange={(e) => {
                      const newValue = e.target.value;
                      setTemperatureStatus(newValue);
                      if (newValue === 'Ø·Ø¨ÙŠØ¹ÙŠØ©') {
                        setTemperatureDetails('');
                      }
                    }}
                    className="w-full px-4 h-[50px] border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent"
                  >
                    <option value="Ø·Ø¨ÙŠØ¹ÙŠØ©">Ø·Ø¨ÙŠØ¹ÙŠØ©</option>
                    <option value="ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠØ©">ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠØ©</option>
                  </select>
                  {temperatureStatus === 'ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠØ©' && (
                    <textarea
                      value={temperatureDetails}
                      onChange={(e) => setTemperatureDetails(e.target.value)}
                      rows={3}
                      required
                      className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent mt-2"
                      placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§..."
                    />
                  )}
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">
                    Ø£Ø¹Ø±Ø§Ø¶ Ù…Ø±Ø¶ÙŠØ© "ØªÙ†ÙØ³ÙŠØ© - Ù‡Ø¶Ù…ÙŠØ© - Ø¨ÙˆÙ„ÙŠØ© - ØªÙ†Ø§Ø³Ù„ÙŠØ© - Ø¹Ø¶Ù„ÙŠØ© - ØºØ¯Ø¯ Ù„Ù…ÙØ§ÙˆÙŠØ©" <span className="text-red-600">*</span>
                  </label>
                  <select
                    value={diseaseSymptoms}
                    onChange={(e) => {
                      const newValue = e.target.value;
                      setDiseaseSymptoms(newValue);
                      if (newValue === 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') {
                        setDiseaseSymptomsDetails('');
                      }
                    }}
                    required
                    className="w-full px-4 h-[50px] border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent"
                  >
                    <option value="Ù„Ø§ ÙŠÙˆØ¬Ø¯">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
                    <option value="ÙŠÙˆØ¬Ø¯">ÙŠÙˆØ¬Ø¯</option>
                  </select>
                  {diseaseSymptoms === 'ÙŠÙˆØ¬Ø¯' && (
                    <textarea
                      value={diseaseSymptomsDetails}
                      onChange={(e) => setDiseaseSymptomsDetails(e.target.value)}
                      rows={3}
                      required
                      className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent mt-2"
                      placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§..."
                    />
                  )}
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">
                    Ø£Ø¹Ø±Ø§Ø¶ Ø¸Ø§Ù‡Ø±ÙŠØ© Ø¨Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ø¸Ù…ÙŠ ÙˆØ§Ù„Ù…ÙØ§ØµÙ„ <span className="text-red-600">*</span>
                  </label>
                  <select
                    value={skeletonSymptoms}
                    onChange={(e) => {
                      const newValue = e.target.value;
                      setSkeletonSymptoms(newValue);
                      if (newValue === 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') {
                        setSkeletonSymptomsDetails('');
                      }
                    }}
                    required
                    className="w-full px-4 h-[50px] border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent"
                  >
                    <option value="Ù„Ø§ ÙŠÙˆØ¬Ø¯">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
                    <option value="ÙŠÙˆØ¬Ø¯">ÙŠÙˆØ¬Ø¯</option>
                  </select>
                  {skeletonSymptoms === 'ÙŠÙˆØ¬Ø¯' && (
                    <textarea
                      value={skeletonSymptomsDetails}
                      onChange={(e) => setSkeletonSymptomsDetails(e.target.value)}
                      rows={3}
                      required
                      className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent mt-2"
                      placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§..."
                    />
                  )}
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">
                    Ø£Ø¹Ø±Ø§Ø¶ Ù…Ø±Ø¶ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù„Ø¯ ÙˆØ§Ù„Ø­ÙˆØ§ÙØ± <span className="text-red-600">*</span>
                  </label>
                  <select
                    value={skinSymptoms}
                    onChange={(e) => {
                      const newValue = e.target.value;
                      setSkinSymptoms(newValue);
                      if (newValue === 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') {
                        setSkinSymptomsDetails('');
                      }
                    }}
                    required
                    className="w-full px-4 h-[50px] border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent"
                  >
                    <option value="Ù„Ø§ ÙŠÙˆØ¬Ø¯">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
                    <option value="ÙŠÙˆØ¬Ø¯">ÙŠÙˆØ¬Ø¯</option>
                  </select>
                  {skinSymptoms === 'ÙŠÙˆØ¬Ø¯' && (
                    <textarea
                      value={skinSymptomsDetails}
                      onChange={(e) => setSkinSymptomsDetails(e.target.value)}
                      rows={3}
                      required
                      className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent mt-2"
                      placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§..."
                    />
                  )}
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">
                    Ø§Ù„ØµÙØ© Ø§Ù„ØªØ´Ø±ÙŠØ­ÙŠØ© "Ø¥Ù† ÙˆØ¬Ø¯Øª" <span className="text-red-600">*</span>
                  </label>
                  <select
                    value={anatomicalFeatures}
                    onChange={(e) => {
                      const newValue = e.target.value;
                      setAnatomicalFeatures(newValue);
                      if (newValue === 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') {
                        setAnatomicalFeaturesDetails('');
                      }
                    }}
                    required
                    className="w-full px-4 h-[50px] border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent"
                  >
                    <option value="Ù„Ø§ ÙŠÙˆØ¬Ø¯">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
                    <option value="ÙŠÙˆØ¬Ø¯">ÙŠÙˆØ¬Ø¯</option>
                  </select>
                  {anatomicalFeatures === 'ÙŠÙˆØ¬Ø¯' && (
                    <textarea
                      value={anatomicalFeaturesDetails}
                      onChange={(e) => setAnatomicalFeaturesDetails(e.target.value)}
                      rows={3}
                      required
                      className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent mt-2"
                      placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§..."
                    />
                  )}
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">
                    Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø¹Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø¸Ø§Ù‡Ø±ÙŠ <span className="text-red-600">*</span>
                  </label>
                  <select
                    value={generalDiagnosis}
                    onChange={(e) => {
                      setGeneralDiagnosis(e.target.value);
                      if (e.target.value !== 'Ø£Ø®Ø±Ù‰') {
                        setGeneralDiagnosisCustom('');
                      }
                    }}
                    required
                    className="w-full px-4 h-[50px] border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent"
                  >
                    <option value="Ø³Ù„ÙŠÙ…">Ø³Ù„ÙŠÙ…</option>
                    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                  </select>
                  {generalDiagnosis === 'Ø£Ø®Ø±Ù‰' && (
                    <textarea
                      value={generalDiagnosisCustom}
                      onChange={(e) => setGeneralDiagnosisCustom(e.target.value)}
                      rows={4}
                      required
                      className="w-full px-4 py-2 mt-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent"
                      placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø¹Ø§Ù…..."
                    />
                  )}
                </div>
              </div>
            </div>

            {/* Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ© */}
            <div className={`rounded-xl p-6 border transition-all ${
              !areLabReportsAvailable() ? 'bg-gradient-to-br from-red-50 to-red-50/50 border-red-300' : 'bg-gradient-to-br from-[#61bf69]/10 to-[#50a857]/10 border-[#61bf69]/30'
            }`}>
              <div className="flex items-center gap-3 mb-6 border-b pb-3" style={{ borderColor: !areLabReportsAvailable() ? '#dc2626' : 'rgba(97, 191, 105, 0.4)' }}>
                <h3 className={`text-xl font-bold ${!areLabReportsAvailable() ? 'text-red-700' : 'text-gray-800'}`}>
                  Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©
                </h3>
                {!areLabReportsAvailable() && (
                  <span className="flex items-center gap-1 text-xs font-semibold text-red-600 bg-red-100 px-3 py-1.5 rounded-full">
                    <AlertCircle className="w-4 h-4" />
                    Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø®Ø¨Ø±ÙŠØ©
                  </span>
                )}
              </div>

              <div className="text-center py-8">
                {printContent?.procedure && labResults.length > 0 && printContent?.procedure?.internal_procedure_number ? (
                  areAllResultsComplete ? (
                    <div className="mb-4 p-4 bg-[#61bf69]/10 border border-[#61bf69]/30 rounded-lg">
                      <p className="text-[#003361] font-semibold">
                        ØªÙ… Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø±ÙŠØ± Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ø±Ù‚Ù… ({printContent.procedure.internal_procedure_number})
                      </p>
                    </div>
                  ) : (
                    <div className="mb-4 p-4 bg-amber-50 border border-amber-300 rounded-lg">
                      <p className="text-amber-800 font-semibold flex items-center justify-center gap-2">
                        <AlertCircle className="w-5 h-5" />
                        ØªÙ… Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø±ÙŠØ± Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¬Ø²Ø¦ÙŠØ§Ù‹
                      </p>
                      <p className="text-amber-600 text-sm mt-2">
                        ({labResults.length} Ù…Ù† {printContent.procedure.samples.length} Ù†ØªÙŠØ¬Ø©)
                      </p>
                    </div>
                  )
                ) : printContent?.procedure && labResults.length === 0 ? (
                  <div className="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                    <p className="text-gray-600 font-semibold">
                      Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
                    </p>
                  </div>
                ) : null}

                <button
                  type="button"
                  onClick={handleShowResults}
                  className="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-[#61bf69] to-[#50a857] text-white rounded-xl font-bold text-lg hover:from-[#50a857] hover:to-[#61bf69] transition-all shadow-lg hover:shadow-xl transform hover:scale-105"
                >
                  <Eye className="w-6 h-6" />
                  Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©
                </button>
                <p className="text-sm text-gray-500 mt-3">
                  Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
                </p>
              </div>
            </div>

            {/* Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª */}
            <AttachmentsSection
              attachments={attachments}
              onAttachmentsChange={setAttachments}
              required={false}
            />

            {/* Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ */}
            <div className={`rounded-xl p-6 border transition-all ${
              !isFinalActionValid() ? 'bg-gradient-to-br from-red-50 to-red-50/50 border-red-300' : 'bg-gradient-to-br from-red-50/30 to-rose-50/30 border-red-100'
            }`}>
              <div className="flex items-center gap-3 mb-4 border-b pb-3" style={{ borderColor: !isFinalActionValid() ? '#dc2626' : 'rgba(239, 68, 68, 0.2)' }}>
                <h3 className={`text-xl font-bold ${!isFinalActionValid() ? 'text-red-700' : 'text-gray-800'}`}>
                  Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ <span className="text-red-600">*</span>
                </h3>
                {!isFinalActionValid() && (
                  <span className="flex items-center gap-1 text-xs font-semibold text-red-600 bg-red-100 px-3 py-1.5 rounded-full">
                    <AlertCircle className="w-4 h-4" />
                    Ø­Ù‚Ù„ Ø¥Ù„Ø²Ø§Ù…ÙŠ Ù…ÙÙ‚ÙˆØ¯
                  </span>
                )}
              </div>

              <p className="text-lg font-bold text-gray-800 mb-4 leading-relaxed">
                Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø¸Ø§Ù‡Ø±ÙŠ ÙˆÙ†ØªÙŠØ¬Ø© Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø±Ø§Øª
              </p>

              <textarea
                value={finalAction}
                onChange={(e) => setFinalAction(e.target.value)}
                rows={4}
                required
                className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#61bf69] focus:border-transparent mb-6"
                placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ..."
              />

              <div className="mt-6 pt-6 border-t-2 border-gray-300">
                <h4 className="text-lg font-bold text-gray-800 mb-3">
                  Ø§Ù„Ù‚Ø±Ø§Ø± Ù„ÙƒÙ„ Ø­ÙŠÙˆØ§Ù† <span className="text-red-600">*</span>
                </h4>
                <p className="text-sm text-gray-600 mb-4">
                  Ø­Ø¯Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„ÙƒÙ„ Ø­ÙŠÙˆØ§Ù† (Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡)
                </p>

                {animals.length === 0 ? (
                  <div className="p-4 bg-gray-50 border border-gray-300 rounded-lg text-center">
                    <p className="text-gray-600">Ù‚Ù… Ø¨Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</p>
                  </div>
                ) : (
                  <div className="space-y-3">
                    {animals.map((animal, index) => {
                      const hasDecision = animal.final_decision && animal.final_decision.trim();
                      return (
                      <div key={index} className={`bg-white/60 border-2 rounded-lg p-4 transition-all ${
                        !hasDecision ? 'border-red-400 shadow-red-200 shadow-lg bg-red-50/30' : 'border-[#61bf69]/30'
                      }`}>
                        <div className="flex items-center justify-between gap-4">
                          <div className="flex-1">
                            <div className="flex items-center gap-3 mb-2">
                              <h5 className={`font-bold ${!hasDecision ? 'text-red-700' : 'text-gray-800'}`}>
                                {animal.animal_type} ({animal.animal_gender})
                              </h5>
                              <span className="text-sm text-gray-600">
                                Ø§Ù„Ø¹Ø¯Ø¯: {animal.animal_count || '-'} | Ø§Ù„Ù†ÙÙˆÙ‚: {animal.death_count || '-'}
                              </span>
                              {!hasDecision && (
                                <span className="flex items-center gap-1 text-xs font-semibold text-red-600 bg-red-100 px-3 py-1 rounded-full">
                                  <AlertCircle className="w-4 h-4" />
                                  ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø±Ø§Ø±
                                </span>
                              )}
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className={`text-sm font-semibold ${!hasDecision ? 'text-red-700' : 'text-gray-700'}`}>Ø§Ù„Ù‚Ø±Ø§Ø±:</span>
                            <div className="flex gap-2">
                              <button
                                type="button"
                                onClick={() => updateAnimalField(index, 'final_decision', 'ÙØ³Ø­')}
                                className={`px-4 py-2 rounded-lg font-semibold transition-all border-2 text-sm ${
                                  animal.final_decision === 'ÙØ³Ø­'
                                    ? 'bg-green-500 text-white border-green-600 shadow-lg'
                                    : 'bg-white text-gray-700 border-gray-300 hover:border-green-500 hover:bg-green-50'
                                }`}
                              >
                                ÙØ³Ø­
                              </button>
                              <button
                                type="button"
                                onClick={() => updateAnimalField(index, 'final_decision', 'Ø­Ø¬Ø±')}
                                className={`px-4 py-2 rounded-lg font-semibold transition-all border-2 text-sm ${
                                  animal.final_decision === 'Ø­Ø¬Ø±'
                                    ? 'bg-yellow-500 text-white border-yellow-600 shadow-lg'
                                    : 'bg-white text-gray-700 border-gray-300 hover:border-yellow-500 hover:bg-yellow-50'
                                }`}
                              >
                                Ø­Ø¬Ø±
                              </button>
                              <button
                                type="button"
                                onClick={() => updateAnimalField(index, 'final_decision', 'Ø¥Ø±Ø¬Ø§Ø¹')}
                                className={`px-4 py-2 rounded-lg font-semibold transition-all border-2 text-sm ${
                                  animal.final_decision === 'Ø¥Ø±Ø¬Ø§Ø¹'
                                    ? 'bg-red-500 text-white border-red-600 shadow-lg'
                                    : 'bg-white text-gray-700 border-gray-300 hover:border-red-500 hover:bg-red-50'
                                }`}
                              >
                                Ø¥Ø±Ø¬Ø§Ø¹
                              </button>
                            </div>
                          </div>
                        </div>

                        {/* Ø®ÙŠØ§Ø±Ø§Øª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø¬Ø± Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø¬Ø± */}
                        {animal.final_decision === 'Ø­Ø¬Ø±' && (
                          <div className="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <label className="block text-sm font-semibold text-gray-700 mb-3">
                              Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø¬Ø± <span className="text-red-600">*</span>
                              <span className="text-xs font-normal text-gray-600 mr-2">(ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù…ÙˆÙ‚Ø¹)</span>
                            </label>
                            <div className="space-y-3">
                              {/* Ø®ÙŠØ§Ø±: Ø­Ø¬Ø± ÙÙŠ Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯ */}
                              <label className="flex items-center gap-3 p-3 bg-white border-2 rounded-lg cursor-pointer transition-all hover:bg-yellow-50 hover:border-yellow-400">
                                <input
                                  type="checkbox"
                                  checked={animal.quarantine_locations?.includes('Ø­Ø¬Ø± ÙÙŠ Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯') || false}
                                  onChange={() => toggleQuarantineLocation(index, 'Ø­Ø¬Ø± ÙÙŠ Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯')}
                                  className="w-5 h-5 text-yellow-500 border-gray-300 rounded focus:ring-yellow-500 focus:ring-2 cursor-pointer"
                                />
                                <span className="text-sm font-semibold text-gray-700">Ø­Ø¬Ø± ÙÙŠ Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯</span>
                              </label>

                              {/* Ø®ÙŠØ§Ø±: Ø­Ø¬Ø± ÙÙŠ Ø§Ù„Ø®Ù…Ø±Ø© */}
                              <div className="space-y-2">
                                <label className="flex items-center gap-3 p-3 bg-white border-2 rounded-lg cursor-pointer transition-all hover:bg-yellow-50 hover:border-yellow-400">
                                  <input
                                    type="checkbox"
                                    checked={animal.quarantine_locations?.includes('Ø­Ø¬Ø± ÙÙŠ Ø§Ù„Ø®Ù…Ø±Ø©') || false}
                                    onChange={() => {
                                      toggleQuarantineLocation(index, 'Ø­Ø¬Ø± ÙÙŠ Ø§Ù„Ø®Ù…Ø±Ø©');
                                      // Ø¥Ø°Ø§ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ØŒ Ø§Ù…Ø³Ø­ Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
                                      if (animal.quarantine_locations?.includes('Ø­Ø¬Ø± ÙÙŠ Ø§Ù„Ø®Ù…Ø±Ø©')) {
                                        const newAnimals = [...animals];
                                        newAnimals[index].quarantine_trader = '';
                                        setAnimals(newAnimals);
                                      }
                                    }}
                                    className="w-5 h-5 text-yellow-500 border-gray-300 rounded focus:ring-yellow-500 focus:ring-2 cursor-pointer"
                                  />
                                  <span className="text-sm font-semibold text-gray-700">Ø­Ø¬Ø± ÙÙŠ Ø§Ù„Ø®Ù…Ø±Ø©</span>
                                </label>

                                {/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯ÙŠÙ† Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ù…Ø®ØªØ§Ø±ÙŠÙ† ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ (Ù†Ø´Ø·/ØºÙŠØ± Ù†Ø´Ø·) */}
                                {animal.quarantine_locations?.includes('Ø­Ø¬Ø± ÙÙŠ Ø§Ù„Ø®Ù…Ø±Ø©') && (
                                  <div className="mr-8">
                                    <label className="block text-xs font-semibold text-gray-600 mb-2">
                                      Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯ÙŠÙ† (Ø­Ø¬Ø± Ø§Ù„Ø®Ù…Ø±Ø©) <span className="text-red-600">*</span>
                                      <span className="text-xs font-normal text-gray-500 mr-2">(ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø³ØªÙˆØ±Ø¯)</span>
                                    </label>

                                    {selectedImporters.length > 0 ? (
                                      <div className="space-y-1.5 max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-2 bg-white">
                                        {selectedImporters.map((importer, idx) => {
                                          const fullImporter = importers.find(i => i.importer_name === importer.name);
                                          const isChecked = animal.quarantine_traders?.includes(importer.name) || false;
                                          const isActive = importer.status === 'Ù†Ø´Ø·';

                                          return (
                                            <label
                                              key={idx}
                                              className={`flex items-center gap-2 p-2 rounded cursor-pointer transition-colors border ${
                                                isActive
                                                  ? 'hover:bg-green-50 border-green-200 bg-green-50/30'
                                                  : 'hover:bg-red-50 border-red-200 bg-red-50/30'
                                              }`}
                                            >
                                              <input
                                                type="checkbox"
                                                checked={isChecked}
                                                onChange={(e) => {
                                                  const newAnimals = [...animals];
                                                  const currentTraders = newAnimals[index].quarantine_traders || [];

                                                  if (e.target.checked) {
                                                    newAnimals[index].quarantine_traders = [...currentTraders, importer.name];
                                                  } else {
                                                    newAnimals[index].quarantine_traders = currentTraders.filter(t => t !== importer.name);
                                                  }

                                                  setAnimals(newAnimals);
                                                }}
                                                className={`w-4 h-4 border-gray-300 rounded focus:ring-2 ${
                                                  isActive
                                                    ? 'text-green-500 focus:ring-green-500'
                                                    : 'text-red-500 focus:ring-red-500'
                                                }`}
                                              />
                                              <span className={`text-sm flex-1 font-semibold ${
                                                isActive ? 'text-green-700' : 'text-red-700'
                                              }`}>
                                                {importer.name}
                                                {fullImporter?.farm_location && (
                                                  <span className={`text-xs font-normal mr-1 ${
                                                    isActive ? 'text-green-600' : 'text-red-600'
                                                  }`}>
                                                    ({fullImporter.farm_location})
                                                  </span>
                                                )}
                                              </span>
                                              <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${
                                                isActive
                                                  ? 'bg-green-100 text-green-700'
                                                  : 'bg-red-100 text-red-700'
                                              }`}>
                                                {importer.status}
                                              </span>
                                            </label>
                                          );
                                        })}
                                      </div>
                                    ) : (
                                      <div className="p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-700">
                                        âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªÙˆØ±Ø¯ÙŠÙ† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¹Ù„Ø§Ù‡
                                      </div>
                                    )}

                                    {(!animal.quarantine_traders || animal.quarantine_traders.length === 0) && selectedImporters.length > 0 && (
                                      <p className="mt-1.5 text-xs text-red-600 font-semibold">âš ï¸ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙˆØ±Ø¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</p>
                                    )}
                                  </div>
                                )}
                              </div>
                            </div>
                            {(!animal.quarantine_locations || animal.quarantine_locations.length === 0) && (
                              <p className="mt-2 text-xs text-red-600 font-semibold">âš ï¸ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</p>
                            )}
                          </div>
                        )}

                        {/* Ù‚ÙˆØ§Ø¦Ù… Ø´Ø±Ø·ÙŠØ© Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø±Ø¬Ø§Ø¹ */}
                        {animal.final_decision === 'Ø¥Ø±Ø¬Ø§Ø¹' && (
                          <div className="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg space-y-3">
                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-3">
                                Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¨Ø¨ <span className="text-red-600">*</span>
                              </label>
                              <div className="grid grid-cols-2 gap-3">
                                <button
                                  type="button"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    const newAnimals = [...animals];
                                    newAnimals[index] = {
                                      ...newAnimals[index],
                                      return_type: 'Ù…Ø±Ø¶ÙŠØ©',
                                      return_category: '',
                                      return_reason: '',
                                      admin_return_reasons: []
                                    };
                                    setAnimals(newAnimals);
                                  }}
                                  className={`px-4 py-3 rounded-xl font-semibold transition-all duration-200 text-sm ${
                                    animal.return_type === 'Ù…Ø±Ø¶ÙŠØ©'
                                      ? 'bg-gradient-to-br from-red-500 to-red-600 text-white shadow-lg shadow-red-500/30 scale-105'
                                      : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-red-400 hover:shadow-md'
                                  }`}
                                >
                                  Ù…Ø±Ø¶ÙŠØ©
                                </button>
                                <button
                                  type="button"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    const newAnimals = [...animals];
                                    newAnimals[index] = {
                                      ...newAnimals[index],
                                      return_type: 'Ø¥Ø¯Ø§Ø±ÙŠØ©',
                                      return_category: '',
                                      return_reason: '',
                                      admin_return_reasons: []
                                    };
                                    setAnimals(newAnimals);
                                  }}
                                  className={`px-4 py-3 rounded-xl font-semibold transition-all duration-200 text-sm ${
                                    animal.return_type === 'Ø¥Ø¯Ø§Ø±ÙŠØ©'
                                      ? 'bg-gradient-to-br from-orange-500 to-orange-600 text-white shadow-lg shadow-orange-500/30 scale-105'
                                      : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-orange-400 hover:shadow-md'
                                  }`}
                                >
                                  Ø¥Ø¯Ø§Ø±ÙŠØ©
                                </button>
                              </div>
                            </div>

                            {animal.return_type === 'Ù…Ø±Ø¶ÙŠØ©' && (
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                  Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø±Ø¶ÙŠ <span className="text-red-600">*</span>
                                </label>
                                <div className="grid grid-cols-2 gap-3">
                                  <div>
                                    <label className="block text-xs font-semibold text-gray-600 mb-1">
                                      ÙØ¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                                    </label>
                                    <select
                                      value={animal.return_category || ''}
                                      onChange={(e) => {
                                        const newCategory = e.target.value;
                                        const newAnimals = [...animals];
                                        newAnimals[index] = {
                                          ...newAnimals[index],
                                          return_category: newCategory,
                                          return_reason: ''
                                        };
                                        setAnimals(newAnimals);
                                      }}
                                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm"
                                      onClick={(e) => e.stopPropagation()}
                                    >
                                      <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>
                                      <option value="A1">A1</option>
                                      <option value="A2">A2</option>
                                      <option value="B">B</option>
                                    </select>
                                  </div>
                                  <div>
                                    <label className="block text-xs font-semibold text-gray-600 mb-1">
                                      Ø§Ù„Ù…Ø±Ø¶
                                    </label>
                                    <select
                                      value={animal.return_reason || ''}
                                      onChange={(e) => {
                                        updateAnimalField(index, 'return_reason', e.target.value);
                                      }}
                                      disabled={!animal.return_category}
                                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm disabled:bg-gray-100 disabled:cursor-not-allowed"
                                      onClick={(e) => e.stopPropagation()}
                                    >
                                      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø¶</option>
                                      {animal.return_category === 'A1' && (
                                        <>
                                          <option value="Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù…Ø§Ù„Ø·ÙŠØ© (Ø§Ù„Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§)">Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù…Ø§Ù„Ø·ÙŠØ© (Ø§Ù„Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§)</option>
                                          <option value="Ø­Ù…Ù‰ Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ù…ØªØµØ¯Ø¹ (RVF)">Ø­Ù…Ù‰ Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ù…ØªØµØ¯Ø¹ (RVF)</option>
                                        </>
                                      )}
                                      {animal.return_category === 'A2' && (
                                        <>
                                          <option value="Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù‚Ø¯ÙŠ ÙÙŠ Ø§Ù„Ø§Ø¨Ù‚Ø§Ø±(LSDV)">Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù‚Ø¯ÙŠ ÙÙŠ Ø§Ù„Ø§Ø¨Ù‚Ø§Ø± (LSDV)</option>
                                          <option value="Ø¬Ø¯Ø±ÙŠ Ø§Ù„Ø£ØºÙ†Ø§Ù… (SPV)">Ø¬Ø¯Ø±ÙŠ Ø§Ù„Ø£ØºÙ†Ø§Ù… (SPV)</option>
                                          <option value="Ø¬Ø¯Ø±ÙŠ Ø§Ù„Ø¬Ù…Ø§Ù„ (CPV)">Ø¬Ø¯Ø±ÙŠ Ø§Ù„Ø¬Ù…Ø§Ù„ (CPV)</option>
                                          <option value="Ø§Ù„Ù„Ø³Ø§Ù† Ø§Ù„Ø£Ø²Ø±Ù‚ (BTV)">Ø§Ù„Ù„Ø³Ø§Ù† Ø§Ù„Ø£Ø²Ø±Ù‚ (BTV)</option>
                                          <option value="Ø§Ù„Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙˆÙŠ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠ ÙÙŠ Ø§Ù„Ù…Ø§Ø¹Ø² (CCP)">Ø§Ù„Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙˆÙŠ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠ ÙÙŠ Ø§Ù„Ù…Ø§Ø¹Ø² (CCP)</option>
                                          <option value="Ø§Ù„Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙˆÙŠ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠ ÙÙŠ Ø§Ù„Ø£Ø¨Ù‚Ø§Ø± (CBP)">Ø§Ù„Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙˆÙŠ Ø§Ù„Ø¨Ù„ÙˆØ±ÙŠ ÙÙŠ Ø§Ù„Ø£Ø¨Ù‚Ø§Ø± (CBP)</option>
                                          <option value="Ø·Ø§Ø¹ÙˆÙ† Ø§Ù„Ù…Ø¬ØªØ±Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© (PPR)">Ø·Ø§Ø¹ÙˆÙ† Ø§Ù„Ù…Ø¬ØªØ±Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© (PPR)</option>
                                          <option value="Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ© (FMD)">Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ© (FMD)</option>
                                        </>
                                      )}
                                      {animal.return_category === 'B' && (
                                        <>
                                          <option value="Ø§Ù„Ø¥Ø³Ù‡Ø§Ù„ Ø§Ù„Ø¨Ù‚Ø±ÙŠ Ø§Ù„ÙÙŠØ±ÙˆØ³ÙŠ (BVD)">Ø§Ù„Ø¥Ø³Ù‡Ø§Ù„ Ø§Ù„Ø¨Ù‚Ø±ÙŠ Ø§Ù„ÙÙŠØ±ÙˆØ³ÙŠ (BVD)</option>
                                          <option value="Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø£Ù†Ù Ø§Ù„Ø±ØºØ§Ù…ÙŠ Ø§Ù„Ø¨Ù‚Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø¯ÙŠ (IBR)">Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø£Ù†Ù Ø§Ù„Ø±ØºØ§Ù…ÙŠ Ø§Ù„Ø¨Ù‚Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø¯ÙŠ (IBR)</option>
                                          <option value="Ù…Ø±Ø¶ Ø§Ù„Ø³Ù„ Ø§Ù„Ø¨Ù‚Ø±ÙŠ (BT)">Ù…Ø±Ø¶ Ø§Ù„Ø³Ù„ Ø§Ù„Ø¨Ù‚Ø±ÙŠ (BT)</option>
                                          <option value="Ù…Ø±Ø¶ Ø§Ù„Ø¯ÙˆØ¯Ø© Ø§Ù„Ø­Ù„Ø²ÙˆÙ†ÙŠØ© (Screw Worm)">Ù…Ø±Ø¶ Ø§Ù„Ø¯ÙˆØ¯Ø© Ø§Ù„Ø­Ù„Ø²ÙˆÙ†ÙŠØ© (Screw Worm)</option>
                                        </>
                                      )}
                                    </select>
                                  </div>
                                </div>
                              </div>
                            )}

                            {animal.return_type === 'Ø¥Ø¯Ø§Ø±ÙŠØ©' && (
                              <div>
                                <div className="flex items-center justify-between mb-2">
                                  <label className="block text-sm font-semibold text-gray-700">
                                    Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© <span className="text-red-600">*</span>
                                  </label>
                                  <button
                                    type="button"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      const currentReasons = animal.admin_return_reasons || [];
                                      updateAnimalField(index, 'admin_return_reasons', [...currentReasons, { type: '', customText: '' }]);
                                    }}
                                    className="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm font-medium flex items-center gap-1"
                                  >
                                    <span>+</span>
                                    <span>Ø¥Ø¶Ø§ÙØ© Ø³Ø¨Ø¨</span>
                                  </button>
                                </div>

                                <div className="space-y-2">
                                  {(!animal.admin_return_reasons || animal.admin_return_reasons.length === 0) ? (
                                    <div className="text-center py-4 text-gray-500 text-sm border-2 border-dashed border-gray-300 rounded-lg">
                                      Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø³Ø¨Ø¨ Ø¨Ø¹Ø¯
                                    </div>
                                  ) : (
                                    animal.admin_return_reasons.map((reason: any, reasonIndex: number) => (
                                      <div key={reasonIndex} className="flex gap-2 items-start">
                                        <div className="flex-1">
                                          {reason.type === 'Ø£Ø®Ø±Ù‰' ? (
                                            <input
                                              type="text"
                                              value={reason.customText || ''}
                                              onChange={(e) => {
                                                const currentReasons = [...(animal.admin_return_reasons || [])];
                                                currentReasons[reasonIndex] = {
                                                  ...currentReasons[reasonIndex],
                                                  customText: e.target.value
                                                };
                                                updateAnimalField(index, 'admin_return_reasons', currentReasons);
                                              }}
                                              placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨..."
                                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm"
                                              onClick={(e) => e.stopPropagation()}
                                            />
                                          ) : (
                                            <select
                                              value={reason.type || ''}
                                              onChange={(e) => {
                                                const currentReasons = [...(animal.admin_return_reasons || [])];
                                                currentReasons[reasonIndex] = {
                                                  ...currentReasons[reasonIndex],
                                                  type: e.target.value,
                                                  customText: ''
                                                };
                                                updateAnimalField(index, 'admin_return_reasons', currentReasons);
                                              }}
                                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm"
                                              onClick={(e) => e.stopPropagation()}
                                            >
                                              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨</option>
                                              <option value="Ù†Ù‚Øµ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø©">Ù†Ù‚Øµ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø©</option>
                                              <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                                            </select>
                                          )}
                                        </div>

                                        <button
                                          type="button"
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            const currentReasons = animal.admin_return_reasons || [];
                                            const updatedReasons = currentReasons.filter((_: any, i: number) => i !== reasonIndex);
                                            updateAnimalField(index, 'admin_return_reasons', updatedReasons);
                                          }}
                                          className="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors mt-0.5"
                                        >
                                          <span className="text-xl">Ã—</span>
                                        </button>
                                      </div>
                                    ))
                                  )}
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ */}
                        {animal.final_decision && (
                          <div className="mt-3 p-2 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800 font-semibold">
                            Ø§Ù„Ù‚Ø±Ø§Ø±: {
                              animal.final_decision === 'Ø­Ø¬Ø±' && animal.quarantine_locations && animal.quarantine_locations.length > 0
                                ? animal.quarantine_locations.map((loc, idx) => {
                                    if (loc === 'Ø­Ø¬Ø± ÙÙŠ Ø§Ù„Ø®Ù…Ø±Ø©' && animal.quarantine_traders && animal.quarantine_traders.length > 0) {
                                      return `${loc} (Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯ÙŠÙ†: ${animal.quarantine_traders.join(', ')})`;
                                    }
                                    return loc;
                                  }).join(' Ùˆ ')
                                : animal.final_decision === 'Ø¥Ø±Ø¬Ø§Ø¹' && animal.return_reason
                                ? `Ø¥Ø±Ø¬Ø§Ø¹ - Ø§Ù„Ø³Ø¨Ø¨: ${animal.return_reason}${animal.return_category ? ` - Ø§Ù„ÙØ¦Ø©: ${animal.return_category}` : ''}`
                                : animal.final_decision
                            }
                          </div>
                        )}
                      </div>
                      );
                    })}
                  </div>
                )}
              </div>

              <div className="mt-6 pt-6 border-t-2 border-gray-300">
                <h4 className="text-lg font-bold text-gray-800 mb-2">
                  Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ <span className="text-red-600">*</span>
                </h4>
                <p className="text-sm text-gray-600 mb-4">
                  ÙŠØªÙ… Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø© Ù„ÙƒÙ„ Ø­ÙŠÙˆØ§Ù† Ø£Ø¹Ù„Ø§Ù‡
                </p>

                {autoGeneratedDecision ? (
                  <div className="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl">
                    <div className="flex items-center justify-center gap-3 mb-2">
                      <div className="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                      <p className="text-blue-900 font-bold text-lg">
                        Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø³ØªÙ†ØªØ¬
                      </p>
                    </div>
                    <div className="text-center">
                      <span className="inline-block px-6 py-3 bg-white border-2 border-blue-400 rounded-lg text-blue-900 font-bold text-xl shadow-md">
                        {autoGeneratedDecision}
                      </span>
                    </div>
                    <p className="text-xs text-blue-700 text-center mt-3">
                      ØªÙ… Ø§Ø³ØªÙ†ØªØ§Ø¬Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø£Ø¹Ù„Ø§Ù‡
                    </p>
                  </div>
                ) : (
                  <div className="p-4 bg-gray-50 border border-gray-300 rounded-lg text-center">
                    <p className="text-gray-600">
                      Ù‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø±Ø§Ø± Ù„ÙƒÙ„ Ø­ÙŠÙˆØ§Ù† Ø£Ø¹Ù„Ø§Ù‡ Ù„ÙŠØªÙ… Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
                    </p>
                  </div>
                )}
              </div>
            </div>

            {/* Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…ÙŠÙ† Ø¨Ø§Ù„ÙƒØ´Ù */}
            <div className={`rounded-xl p-6 border transition-all ${
              !areDoctorsAvailable() ? 'bg-gradient-to-br from-red-50 to-red-50/50 border-red-300' : 'bg-gradient-to-br from-[#003361]/5 to-[#004d8c]/5 border-[#003361]/20'
            }`}>
              <div className="flex items-center justify-between mb-6 border-b pb-3" style={{ borderColor: !areDoctorsAvailable() ? '#dc2626' : 'rgba(0, 51, 97, 0.3)' }}>
                <div className="flex items-center gap-3">
                  <h3 className={`text-xl font-bold ${!areDoctorsAvailable() ? 'text-red-700' : 'text-gray-800'}`}>
                    Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…ÙŠÙ† Ø¨Ø§Ù„ÙƒØ´Ù ÙˆØ³Ø­Ø¨ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                  </h3>
                  {!areDoctorsAvailable() && (
                    <span className="flex items-center gap-1 text-xs font-semibold text-red-600 bg-red-100 px-3 py-1.5 rounded-full">
                      <AlertCircle className="w-4 h-4" />
                      Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ø¡
                    </span>
                  )}
                </div>
                {isDataImported && (
                  <span className="text-xs bg-[#61bf69]/20 text-[#003361] px-3 py-1 rounded-full font-semibold">
                    ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
                  </span>
                )}
              </div>

              {doctors.length === 0 ? (
                <div className="text-center py-8 bg-white/60 rounded-lg border border-teal-200">
                  <p className="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù† Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</p>
                </div>
              ) : (
                <div className="bg-gray-100 rounded-lg p-4 border border-teal-200">
                  <ul className="space-y-2">
                    {doctors.map((doctor, index) => (
                      <li key={index} className="flex items-center gap-2 text-gray-700">
                        <span className="w-2 h-2 bg-teal-500 rounded-full"></span>
                        <span className="font-semibold">{doctor}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>

            {/* ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© */}
            {animals.length > 0 && animals.filter(a => !isAnimalValid(a)).length > 0 && (
              <div className="bg-red-50 border-2 border-red-300 rounded-xl p-5 flex items-start gap-4">
                <AlertCircle className="w-6 h-6 text-red-600 flex-shrink-0 mt-1" />
                <div className="flex-1">
                  <h4 className="text-lg font-bold text-red-800 mb-2">ØªÙ†Ø¨ÙŠÙ‡: ÙŠÙˆØ¬Ø¯ Ø­Ù‚ÙˆÙ„ Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù†Ø§Ù‚ØµØ©</h4>
                  <p className="text-red-700 mb-3">
                    ÙŠÙˆØ¬Ø¯ <span className="font-bold text-xl">{animals.filter(a => !isAnimalValid(a)).length}</span> Ù…Ù† Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ„ Ø¥Ù„Ø²Ø§Ù…ÙŠØ© ÙØ§Ø±ØºØ©.
                    ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.
                  </p>
                  <ul className="list-disc list-inside text-red-600 text-sm space-y-1">
                    {animals.map((animal, index) => !isAnimalValid(animal) && (
                      <li key={index}>
                        Ø§Ù„Ø­ÙŠÙˆØ§Ù† {index + 1}:
                        {!animal.animal_type && ' Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†'}
                        {!animal.animal_gender && ' - Ø¬Ù†Ø³ Ø§Ù„Ø­ÙŠÙˆØ§Ù†'}
                        {(!animal.animal_count || animal.animal_count === '') && ' - Ø¹Ø¯Ø¯ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª'}
                        {(!animal.death_count || animal.death_count === '') && ' - Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙÙˆÙ‚'}
                        {(!animal.final_decision || animal.final_decision === '') && ' - Ø§Ù„Ù‚Ø±Ø§Ø±'}
                        {(animal.final_decision === 'Ø­Ø¬Ø±' && (!animal.quarantine_location || animal.quarantine_location === '')) && ' - Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø¬Ø±'}
                        {(animal.final_decision === 'Ø¥Ø±Ø¬Ø§Ø¹' && (!animal.return_reason || animal.return_reason === '')) && ' - Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹'}
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            )}

            {/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ */}
            <div className="flex justify-end gap-4 pt-6 border-t border-gray-200">
              <button
                type="button"
                className="px-8 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-semibold"
              >
                Ø¥Ù„ØºØ§Ø¡
              </button>
              <button
                type="submit"
                className="px-8 py-3 bg-gradient-to-r from-[#61bf69] to-[#50a857] text-white rounded-lg hover:from-[#50a857] hover:to-[#61bf69] transition-all duration-300 font-semibold shadow-lg hover:shadow-xl"
              >
                Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              </button>
            </div>
          </form>
        </div>
      </div>

      {/* Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */}
      {showResultsModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div className="flex-1 overflow-y-auto p-8">
              <div className="max-w-4xl mx-auto">
                {!printContent || labResults.length === 0 ? (
                  <div className="text-center py-16">
                    <button
                      onClick={() => setShowResultsModal(false)}
                      className="absolute top-4 left-4 p-2 hover:bg-gray-100 rounded-full transition-colors"
                    >
                      <X className="w-6 h-6 text-gray-500" />
                    </button>
                    <FileText className="w-20 h-20 text-gray-300 mx-auto mb-4" />
                    <h3 className="text-2xl font-bold text-gray-600 mb-2">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù… ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯</h3>
                    <p className="text-gray-500 mb-6">Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ù†ØªØ§Ø¦Ø¬ Ù…Ø®ØªØ¨Ø±ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                    <button
                      onClick={() => setShowResultsModal(false)}
                      className="px-8 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-semibold"
                    >
                      Ø¥ØºÙ„Ø§Ù‚
                    </button>
                  </div>
                ) : (
                  <>
                    <div className="flex items-center justify-between mb-6 pb-4 border-b-2 border-gray-200">
                      <button
                        onClick={() => setShowResultsModal(false)}
                        className="p-2 hover:bg-gray-100 rounded-full transition-colors"
                      >
                        <X className="w-6 h-6 text-gray-500" />
                      </button>
                      <div className="text-center flex-1">
                        <div className="flex items-center justify-center gap-3 mb-2">
                          <div className="w-16 h-16 bg-[#003361] rounded-xl flex items-center justify-center">
                            <FileText className="w-10 h-10 text-white" />
                          </div>
                        </div>
                        <h1 className="text-2xl font-bold text-[#003361] mb-1">
                          Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø¨Ù…Ø­Ø¬Ø± Ù…ÙŠÙ†Ø§Ø¡ Ø¬Ø¯Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ - Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ
                        </h1>
                        <p className="text-gray-600 font-semibold">Ù†ØªÙŠØ¬Ø© ÙØ­Øµ Ù…Ø®Ø¨Ø±ÙŠ</p>
                      </div>
                      <div className="w-6"></div>
                    </div>
                  {/* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ */}
                  {printContent && printContent.procedure && (
                    <div className="grid grid-cols-2 gap-6 mb-6">
                      <div className="bg-[#003361]/5 p-4 rounded-lg">
                        <h3 className="font-bold text-[#003361] mb-3 text-right">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                        <div className="space-y-2 text-right text-sm">
                          <div><span className="font-semibold">Ø±Ù‚Ù… Ø¥Ø¬Ø±Ø§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø±:</span> {printContent.procedure.internal_procedure_number || '-'}</div>
                          <div><span className="font-semibold">Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ:</span> {printContent.procedure.external_procedure_number || '-'}</div>
                          <div><span className="font-semibold">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</span> {printContent.procedure.client_name}</div>
                          <div><span className="font-semibold">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</span> {printContent.procedure.reception_date}</div>
                          <div><span className="font-semibold">Ø¨Ù„Ø¯ Ø§Ù„Ù…Ù†Ø´Ø£:</span> {printContent.procedure.country_port || '-'}</div>
                        </div>
                      </div>
                      <div className="bg-[#00a651]/5 p-4 rounded-lg">
                        <h3 className="font-bold text-[#00a651] mb-3 text-right">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h3>
                        <div className="space-y-2 text-right text-sm">
                          <div><span className="font-semibold">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ:</span> {printContent.procedure.external_procedure_date || '-'}</div>
                          <div><span className="font-semibold">Ù…Ø³ØªÙ„Ù… Ø§Ù„Ø¹ÙŠÙ†Ø© ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø±:</span> {printContent.procedure.receiver_name}</div>
                          <div><span className="font-semibold">Ù…ØµØ¯Ø± Ø§Ù„Ø¹ÙŠÙ†Ø©:</span> {printContent.procedure.sample_origin || '-'}</div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */}
                  <div>
                    <h3 className="font-bold text-gray-900 mb-3 text-right">Ø§Ù„Ø¹ÙŠÙ†Ø§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                    <div className="space-y-3">
                      {printContent.samples.map(({ sample, result }: any, index: number) => (
                        <div key={sample.id} className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                          <div className="flex items-center justify-between mb-3">
                            <div>
                              {result && (
                                <span className={`px-3 py-1 rounded text-sm font-semibold ${
                                  result.test_result === 'positive' || result.test_result === 'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯' ? 'bg-red-100 text-red-800' :
                                  result.test_result === 'negative' || result.test_result === 'Ø³Ù„Ø¨ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯' ? 'bg-green-100 text-green-800' :
                                  'bg-blue-100 text-blue-800'
                                }`}>
                                  {getResultLabel(result.test_result)}
                                </span>
                              )}
                            </div>
                            <h4 className="text-base font-bold text-[#003361]">
                              {sample.sample_number ? `Ø±Ù‚Ù… Ø§Ù„Ø¹ÙŠÙ†Ø©: ${sample.sample_number}` : `Ø¹ÙŠÙ†Ø© #${index + 1}`}
                            </h4>
                          </div>
                          <div className="grid grid-cols-3 gap-3 text-right text-sm">
                            <div className="flex items-center gap-2">
                              <span className="text-gray-500 font-medium">Ø§Ù„Ù‚Ø³Ù…:</span>
                              <span className="text-gray-900">{sample.department}</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <span className="text-gray-500 font-medium">Ø§Ù„ÙØ­Øµ:</span>
                              <span className="text-gray-900">{sample.requested_test}</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <span className="text-gray-500 font-medium">Ù†ÙˆØ¹ Ø§Ù„Ø¹ÙŠÙ†Ø©:</span>
                              <span className="text-gray-900">{sample.sample_type}</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <span className="text-gray-500 font-medium">Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†:</span>
                              <span className="text-gray-900">{sample.animal_type}</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <span className="text-gray-500 font-medium">Ø§Ù„Ø¹Ø¯Ø¯:</span>
                              <span className="text-gray-900 font-semibold">{sample.sample_count}</span>
                            </div>
                            {result && (
                              <>
                                <div className="flex items-center gap-2">
                                  <span className="text-gray-500 font-medium">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©:</span>
                                  <span className="text-gray-900">{result.test_method}</span>
                                </div>
                                <div className="flex items-center gap-2">
                                  <span className="text-gray-500 font-medium">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ:</span>
                                  <span className="text-gray-900">{result.test_date || '-'}</span>
                                </div>
                                <div className="flex items-center gap-2">
                                  <span className="text-gray-500 font-medium">Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©:</span>
                                  <span className="text-red-600 font-bold">{result.positive_samples}</span>
                                </div>
                                {(result.test_result === 'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯' || result.test_result === 'Ø³Ù„Ø¨ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯') && (
                                  <>
                                    <div className="flex items-center gap-2">
                                      <span className="text-gray-500 font-medium">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯:</span>
                                      <span className="text-red-600 font-bold">
                                        {result.confirmed_positive_samples !== null && result.confirmed_positive_samples !== undefined ? result.confirmed_positive_samples : '-'}
                                      </span>
                                    </div>
                                    <div className="col-span-3 flex items-start gap-2">
                                      <span className="text-gray-500 font-medium">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ÙŠ:</span>
                                      <span className="text-gray-900">
                                        {result.confirmatory_test_method && result.confirmatory_test_method.trim() !== '' ? result.confirmatory_test_method : '-'}
                                      </span>
                                    </div>
                                  </>
                                )}
                                {result.is_vaccination_efficiency_test && result.vaccination_efficiency_percentage && (
                                  <div className="col-span-3 bg-[#61bf69]/10 p-3 rounded border border-[#61bf69]/30 flex gap-2">
                                    <span className="text-[#003361] font-semibold">Ù†Ø³Ø¨Ø© ÙƒÙØ§Ø¡Ø© Ø§Ù„ØªØ­ØµÙŠÙ†:</span>
                                    <span className="text-[#003361] font-bold">{result.vaccination_efficiency_percentage}%</span>
                                  </div>
                                )}
                                <div className="col-span-3 flex items-start gap-2">
                                  <span className="text-gray-500 font-medium">Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠÙŠÙ†:</span>
                                  <span className="text-gray-900">{result.specialists?.join('ØŒ ') || '-'}</span>
                                </div>
                                {result.notes && (
                                  <div className="col-span-3 flex items-start gap-2">
                                    <span className="text-gray-500 font-medium">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span>
                                    <span className="text-gray-900">{result.notes}</span>
                                  </div>
                                )}
                              </>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="mt-8 pt-6 border-t-2 border-gray-200">
                    <div className="bg-gray-50 rounded-lg p-4 text-center">
                      <p className="text-gray-900 font-semibold mb-2 text-sm">
                        Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡Ù‡ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø¨Ù…Ø­Ø¬Ø± Ù…ÙŠÙ†Ø§Ø¡ Ø¬Ø¯Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ
                      </p>
                      <p className="text-red-600 font-medium mb-2 text-xs">
                        ØªØ¹ØªØ¨Ø± Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø³Ø±ÙŠØ© ÙˆØºÙŠØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¯Ø§ÙˆÙ„ ÙˆÙŠØ¹Ø±Ø¶Ùƒ ØªØ¯Ø§ÙˆÙ„Ù‡Ø§ Ø£Ùˆ ØªØµÙˆÙŠØ±Ù‡Ø§ Ù„Ù„Ù…Ø³Ø§Ø¦Ù„Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©
                      </p>
                      <p className="text-gray-600 text-xs">
                        Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­Ø¬Ø± Ù…ÙŠÙ†Ø§Ø¡ Ø¬Ø¯Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ
                      </p>
                    </div>
                  </div>
                  </>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Success Modal */}
      {showSuccessModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl max-w-md w-full shadow-2xl">
            <div className="p-8 text-center">
              <div className="flex items-center justify-center w-20 h-20 rounded-full bg-green-100 mx-auto mb-4">
                <svg className="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <h3 className="text-2xl font-bold text-gray-900 mb-3">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­</h3>
              <p className="text-gray-600 mb-6 text-lg">
                ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­
              </p>
              <button
                onClick={() => setShowSuccessModal(false)}
                className="w-full bg-[#61bf69] text-white py-3 rounded-lg hover:bg-[#50a857] transition-colors font-bold text-lg shadow-md"
              >
                Ø¥ØºÙ„Ø§Ù‚
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
