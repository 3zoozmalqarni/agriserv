import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { Search, Eye, X, Ship, Plus, Trash2, CreditCard as Edit, ChevronDown, Truck, FileText, Copy } from 'lucide-react';
import { useAuth } from '../../../hooks/useAuth.tsx';
import toast from 'react-hot-toast';
import PageHeader from '../../shared/PageHeader';
import { vetDB } from '../../../lib/vetDatabase';
import SearchInputWithPaste from '../../shared/SearchInputWithPaste';

interface AnimalShipment {
  id: string;
  procedure_number: string;
  procedure_date?: string;
  transport_method: string;
  origin_country: string;
  importer_name: string;
  arrival_time: string;
  animals: any[];
  temperature_status: string;
  temperature_details: string;
  disease_symptoms: string;
  disease_symptoms_details: string;
  skeleton_symptoms: string;
  skeleton_symptoms_details: string;
  skin_symptoms: string;
  skin_symptoms_details: string;
  anatomical_features: string;
  anatomical_features_details: string;
  general_diagnosis: string;
  final_action: string;
  doctors: string[];
  created_at: string;
  attachments?: any[];
  final_decision?: string;
  arrival_date?: string;
}

interface TraderEntry {
  id: string;
  importer_name: string;
  permit_number: string;
  statement_number: string;
  animal_count: string;
  animal_type: string;
  quarantine_location: string;
  quarantine_location_custom?: string;
  notes: string;
  reasons?: string[];
}

export default function VetQuarantineRecords() {
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedShipment, setSelectedShipment] = useState<AnimalShipment | null>(null);
  const [showViewModal, setShowViewModal] = useState(false);
  const [showDataEntryModal, setShowDataEntryModal] = useState(false);
  const [shipments, setShipments] = useState<AnimalShipment[]>([]);
  const [loading, setLoading] = useState(true);

  const [selectedReasons, setSelectedReasons] = useState<string[]>([]);
  const [customReason, setCustomReason] = useState('');
  const [showCustomReason, setShowCustomReason] = useState(false);
  const [traderEntries, setTraderEntries] = useState<TraderEntry[]>([]);
  const [showTruckStatementModal, setShowTruckStatementModal] = useState(false);
  const [selectedTraderForTruck, setSelectedTraderForTruck] = useState<TraderEntry | null>(null);
  const [showSingleTruckModal, setShowSingleTruckModal] = useState(false);
  const [selectedTraderForSingleTruck, setSelectedTraderForSingleTruck] = useState<TraderEntry | null>(null);
  const [customReasonEntry, setCustomReasonEntry] = useState<{[key: string]: boolean}>({});
  const [customReasonInputs, setCustomReasonInputs] = useState<{[key: string]: string}>({});
  const [singleTruckData, setSingleTruckData] = useState<{[key: string]: {driverName: string; plateNumber: string; departureDateTime: string; trucksCount: string; animalCount: string; animalType: string;}}>({});

  const handleSaveSingleTruckData = useCallback((traderId: string, data: {driverName: string; plateNumber: string; departureDateTime: string; trucksCount: string; animalCount: string; animalType: string;}) => {
    setSingleTruckData(prev => ({
      ...prev,
      [traderId]: data
    }));
  }, []);

  const reasonOptions = [
    'تحصين FMD',
    'تحصين PPR',
    'أخرى'
  ];

  const auth = useAuth();
  const { hasPermission } = auth || {};

  useEffect(() => {
    loadQuarantineShipments();

    const handleDataChanged = () => {
      loadQuarantineShipments();
    };

    window.addEventListener('procedures-data-changed', handleDataChanged);
    window.addEventListener('shipment-data-changed', handleDataChanged);
    window.addEventListener('vet-data-changed', handleDataChanged);

    return () => {
      window.removeEventListener('procedures-data-changed', handleDataChanged);
      window.removeEventListener('shipment-data-changed', handleDataChanged);
      window.removeEventListener('vet-data-changed', handleDataChanged);
    };
  }, []);

  const loadQuarantineShipments = async () => {
    setLoading(true);
    try {
      const allShipments = await vetDB.getAnimalShipments();

      // فلترة الإرساليات التي تحتوي على حيوانات قرارها "حجر"
      const quarantineShipments = allShipments.filter(shipment =>
        shipment.animals?.some(animal => animal.final_decision === 'حجر')
      );

      setShipments(quarantineShipments || []);
    } catch (error) {
      console.error('Error loading quarantine shipments:', error);
      toast.error('حدث خطأ في تحميل سجل الحجر');
    } finally {
      setLoading(false);
    }
  };

  const filteredRecords = shipments.filter(record => {
    if (!searchTerm) return true;

    const searchLower = searchTerm.toLowerCase();
    const matchesSearch =
      record.procedure_number.toLowerCase().includes(searchLower) ||
      record.importer_name.toLowerCase().includes(searchLower) ||
      (record.origin_country || '').toLowerCase().includes(searchLower);

    // البحث في بيانات المستوردين (رقم الإذن ورقم البيان)
    const quarantinedAnimals = record.animals?.filter(animal => animal.final_decision === 'حجر') || [];
    if (quarantinedAnimals.length > 0 && window.electronAPI?.getQuarantineTradersByShipmentId) {
      // سنبحث في البيانات المحفوظة
      // ولكن لأسباب أداء، سنبحث فقط في الحقول الأساسية
    }

    return matchesSearch;
  });

  const handleView = (id: string) => {
    const shipment = shipments.find(s => s.id === id);
    if (shipment) {
      setSelectedShipment(shipment);
      setShowViewModal(true);
    }
  };

  const handleDataEntry = async (id: string) => {
    const shipment = shipments.find(s => s.id === id);
    if (shipment) {
      setSelectedShipment(shipment);
      setShowDataEntryModal(true);
      setSelectedReasons([]);
      setCustomReason('');

      // تحميل بيانات المستوردين المحفوظة من SQLite
      if (window.electronAPI?.getQuarantineTradersByShipmentId) {
        try {
          const data = await window.electronAPI.getQuarantineTradersByShipmentId(shipment.procedure_number);

          if (data && data.length > 0) {
            const loadedEntries: TraderEntry[] = data.map(trader => ({
              id: trader.id,
              importer_name: trader.importer_name,
              permit_number: trader.permit_number,
              statement_number: trader.statement_number,
              animal_count: trader.animal_count,
              animal_type: trader.animal_type,
              quarantine_location: trader.quarantine_location,
              quarantine_location_custom: trader.quarantine_location_custom || '',
              notes: trader.notes || '',
              reasons: trader.reasons || []
            }));
            setTraderEntries(loadedEntries);
          } else {
            setTraderEntries([]);
          }
        } catch (error) {
          console.error('Error loading trader data:', error);
          setTraderEntries([]);
        }
      } else {
        setTraderEntries([]);
      }
    }
  };

  const handleAddTrader = () => {
    const newEntry: TraderEntry = {
      id: crypto.randomUUID(),
      importer_name: '',
      permit_number: '',
      statement_number: '',
      animal_count: '',
      animal_type: '',
      quarantine_location: '',
      quarantine_location_custom: '',
      notes: '',
      reasons: []
    };
    setTraderEntries([...traderEntries, newEntry]);
  };

  const handleRemoveTrader = (id: string) => {
    setTraderEntries(traderEntries.filter(entry => entry.id !== id));
  };

  const handleTraderChange = (id: string, field: keyof TraderEntry, value: string | string[]) => {
    setTraderEntries(traderEntries.map(entry => {
      if (entry.id === id) {
        const updated = { ...entry, [field]: value };

        // تنظيف الحقل المخصص عند تغيير مكان الحجر من "أخرى" إلى خيار آخر
        if (field === 'quarantine_location' && value !== 'أخرى') {
          updated.quarantine_location_custom = '';
        }

        // تعبئة مكان الحجر تلقائياً حسب نوع الحيوان
        if (field === 'animal_type' && typeof value === 'string' && selectedShipment) {
          const animal = selectedShipment.animals?.find(a => a.animal_type === value && a.final_decision === 'حجر');
          if (animal) {
            // دعم البيانات الجديدة (quarantine_locations) والقديمة (quarantine_location)
            if (animal.quarantine_locations && animal.quarantine_locations.length > 0) {
              // استخدام أول موقع من المصفوفة كقيمة افتراضية
              const firstLocation = animal.quarantine_locations[0];
              if (firstLocation === 'حجر في مزرعة المستورد') {
                updated.quarantine_location = 'مزرعة المستورد';
              } else if (firstLocation === 'حجر في الخمرة') {
                updated.quarantine_location = 'الخمرة';
              } else {
                updated.quarantine_location = 'أخرى';
                updated.quarantine_location_custom = firstLocation;
              }
            } else if (animal.quarantine_location) {
              updated.quarantine_location = animal.quarantine_location;
            }
          }
        }

        return updated;
      }
      return entry;
    }));
  };

  const handleReasonToggle = (reason: string) => {
    if (!selectedReasons.includes(reason)) {
      setSelectedReasons([...selectedReasons, reason]);
    }
  };

  const removeReason = (reason: string) => {
    setSelectedReasons(selectedReasons.filter(r => r !== reason));
  };

  const addCustomReason = (reason: string) => {
    if (reason && !selectedReasons.includes(reason)) {
      setSelectedReasons([...selectedReasons, reason]);
      setCustomReason('');
      setShowCustomReason(false);
    }
  };

  const handlePrintTradersList = () => {
    if (!selectedShipment) return;

    const printArea = document.querySelector('.traders-print-content');
    if (!printArea) {
      toast.error('خطأ في العثور على المحتوى للطباعة');
      return;
    }

    // الحصول على العناصر الأصلية قبل الاستنساخ
    const originalSelects = printArea.querySelectorAll('select');
    const originalInputs = printArea.querySelectorAll('input[type="text"]');

    // حفظ القيم من العناصر الأصلية
    const selectValues: { value: string; text: string }[] = [];
    originalSelects.forEach((select) => {
      const selectEl = select as HTMLSelectElement;
      const selectedOption = selectEl.options[selectEl.selectedIndex];
      selectValues.push({
        value: selectEl.value,
        text: selectedOption && selectedOption.value !== '' ? selectedOption.text : ''
      });
    });

    const inputValues: string[] = [];
    originalInputs.forEach((input) => {
      const inputEl = input as HTMLInputElement;
      inputValues.push(inputEl.value || '');
    });

    const clonedContent = printArea.cloneNode(true) as HTMLElement;

    // استبدال عناصر select بالقيمة المختارة
    const clonedSelects = clonedContent.querySelectorAll('select');
    clonedSelects.forEach((select, index) => {
      if (selectValues[index]) {
        const span = document.createElement('span');
        span.textContent = selectValues[index].text;
        span.style.cssText = 'display: block; text-align: center; padding: 2px; font-size: 10px; line-height: 1.4;';
        select.parentNode?.replaceChild(span, select);
      }
    });

    // استبدال عناصر input بالقيمة المدخلة
    const clonedInputs = clonedContent.querySelectorAll('input[type="text"]');
    clonedInputs.forEach((input, index) => {
      if (inputValues[index] !== undefined) {
        const span = document.createElement('span');
        span.textContent = inputValues[index];
        span.style.cssText = 'display: block; text-align: center; padding: 2px; font-size: 10px; line-height: 1.4;';
        input.parentNode?.replaceChild(span, input);
      }
    });

    // إزالة العناصر غير المطلوبة للطباعة
    const noPrintElements = clonedContent.querySelectorAll('button, .no-print');
    noPrintElements.forEach(el => el.remove());

    // Create table structure with repeating header
    const printTable = document.createElement('table');
    printTable.style.width = '100%';
    printTable.style.borderCollapse = 'collapse';

    // Create thead (will repeat on every page)
    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr>
        <th style="padding: 0;">
          <div style="text-align: center; padding: 6px 0; margin-bottom: 6px; border-bottom: 2px solid #008a40;">
            <h1 style="color: #003361 !important; font-size: 15px; font-weight: bold; margin: 0 0 2px 0;">القسم البيطري بمحجر ميناء جدة الإسلامي</h1>
            <h2 style="color: #00a651 !important; font-size: 13px; font-weight: 600; margin: 0 0 6px 0;">أسماء المستوردين الذين تمت الموافقة لهم بتحميل المواشي</h2>
            <div style="border: 1px solid #e5e7eb; border-radius: 4px; padding: 8px 0; margin-top: 6px; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 8px; min-height: 32px;">
              <div style="font-size: 7px; display: flex; align-items: center; gap: 3px;"><span style="font-weight: 700; color: #6b7280;">رقم الإجراء:</span> <span style="font-weight: 600; color: #111827;">${selectedShipment.procedure_number || 'غير محدد'}</span></div>
              <div style="font-size: 7px; display: flex; align-items: center; gap: 3px;"><span style="font-weight: 700; color: #6b7280;">اسم المستورد:</span> <span style="font-weight: 600; color: #111827;">${selectedShipment.importer_name}</span></div>
              <div style="font-size: 7px; display: flex; align-items: center; gap: 3px;"><span style="font-weight: 700; color: #6b7280;">التاريخ:</span> <span style="font-weight: 600; color: #111827;">${selectedShipment.procedure_date || selectedShipment.arrival_date || new Date().toLocaleDateString('en-GB')}</span></div>
              <div style="font-size: 7px; display: flex; align-items: center; gap: 3px;"><span style="font-weight: 700; color: #6b7280;">بلد المنشأ:</span> <span style="font-weight: 600; color: #111827;">${selectedShipment.origin_country || 'غير محدد'}</span></div>
            </div>
          </div>
        </th>
      </tr>
    `;

    // Create tbody with content
    const tbody = document.createElement('tbody');
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.style.padding = '0';
    td.appendChild(clonedContent);
    tr.appendChild(td);
    tbody.appendChild(tr);

    printTable.appendChild(thead);
    printTable.appendChild(tbody);

    const printContainer = document.createElement('div');
    printContainer.id = 'temp-print-container-traders';
    printContainer.style.display = 'none';
    printContainer.appendChild(printTable);
    document.body.appendChild(printContainer);

    // Add print styles
    const printStyles = document.createElement('style');
    printStyles.id = 'dynamic-print-styles-traders';
    printStyles.textContent = `
      @media print {
        @page {
          size: A4 landscape;
          margin: 10mm !important;
        }
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          color-adjust: exact !important;
        }

        body {
          background: white !important;
          margin: 0 !important;
          padding: 0 !important;
        }

        table {
          width: 100% !important;
          border-collapse: collapse !important;
        }

        thead {
          display: table-header-group !important;
        }

        tbody {
          display: table-row-group !important;
        }

        th, td {
          page-break-inside: avoid !important;
        }

        body::after {
          content: "\u0647\u0630\u0627 \u0627\u0644\u0628\u064a\u0627\u0646 \u062a\u0645 \u0625\u0646\u0634\u0627\u0624\u0647 \u0644\u0627\u0633\u062a\u062e\u062f\u0627\u0645\u0627\u062a \u0627\u0644\u0642\u0633\u0645 \u0627\u0644\u0628\u064a\u0637\u0631\u064a \u0628\u0645\u062d\u062c\u0631 \u0645\u064a\u0646\u0627\u0621 \u062c\u062f\u0629 \u0627\u0644\u0625\u0633\u0644\u0627\u0645\u064a \u2022 \u062a\u0639\u062a\u0628\u0631 \u0647\u0630\u0647 \u0627\u0644\u0648\u062b\u064a\u0642\u0629 \u0633\u0631\u064a\u0629 \u0648\u063a\u064a\u0631 \u0642\u0627\u0628\u0644\u0629 \u0644\u0644\u062a\u062f\u0627\u0648\u0644 \u0648\u064a\u0639\u0631\u0636\u0643 \u062a\u062f\u0627\u0648\u0644\u0647\u0627 \u0623\u0648 \u062a\u0635\u0648\u064a\u0631\u0647\u0627 \u0644\u0644\u0645\u0633\u0627\u0626\u0644\u0629 \u0627\u0644\u0642\u0627\u0646\u0648\u0646\u064a\u0629 \u2022 \u0644\u0644\u0645\u0644\u0627\u062d\u0638\u0627\u062a \u0648\u0627\u0644\u0627\u0633\u062a\u0641\u0633\u0627\u0631\u0627\u062a \u0627\u0644\u062a\u0648\u0627\u0635\u0644 \u0645\u0639 \u0625\u062f\u0627\u0631\u0629 \u0645\u062d\u062c\u0631 \u0645\u064a\u0646\u0627\u0621 \u062c\u062f\u0629 \u0627\u0644\u0625\u0633\u0644\u0627\u0645\u064a" !important;
          position: fixed !important;
          bottom: 0 !important;
          left: 0 !important;
          right: 0 !important;
          width: 100% !important;
          text-align: center !important;
          font-size: 6.5px !important;
          padding: 8px 10px !important;
          background: white !important;
          border-top: 2px solid #008a40 !important;
          color: #374151 !important;
          font-weight: 600 !important;
          line-height: 1.3 !important;
          z-index: 9999 !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        body > *:not(#temp-print-container-traders) {
          display: none !important;
        }

        #temp-print-container-traders {
          display: block !important;
          position: static !important;
          background: white !important;
          padding: 0 !important;
          margin: 0 !important;
          width: 100% !important;
          box-sizing: border-box !important;
        }

        #temp-print-container-traders > * {
          margin: 0 !important;
          padding: 0 !important;
        }

        #temp-print-container-traders * {
          visibility: visible !important;
        }

        .no-print,
        button,
        svg {
          display: none !important;
        }
        input, select {
          display: none !important;
        }

        h1, h2, h3 {
          page-break-after: avoid !important;
        }

        h1 { color: #003361 !important; }
        h2 { color: #00a651 !important; }
        h3 { color: #6b7280 !important; }

        .text-gray-900 { color: #111827 !important; }
        .text-gray-700 { color: #374151 !important; }
        .text-gray-600 { color: #4b5563 !important; }
        .text-gray-500 { color: #6b7280 !important; }

        .traders-print-content {
          padding: 0 !important;
          margin: 0 !important;
        }

        .traders-print-content > div {
          page-break-inside: auto !important;
          margin-bottom: 8px !important;
        }

        .traders-print-content table {
          width: 100% !important;
          border-collapse: separate !important;
          border-spacing: 0 !important;
          border: none !important;
          overflow: hidden !important;
        }

        .traders-print-content thead th {
          background: #f5f5f5 !important;
          color: #003361 !important;
          border: none !important;
          border-bottom: 1px solid #e5e7eb !important;
          padding: 6px 4px !important;
          font-size: 11px !important;
          font-weight: bold !important;
          line-height: 1.3 !important;
          height: 32px !important;
          vertical-align: middle !important;
          text-align: center !important;
        }

        .traders-print-content tbody tr {
          height: 26px !important;
        }

        .traders-print-content tbody tr:nth-child(even) {
          background: linear-gradient(to right, #f8fafc 0%, #f1f5f9 100%) !important;
        }

        .traders-print-content tbody tr:nth-child(odd) {
          background: white !important;
        }

        .traders-print-content tbody td {
          border: none !important;
          border-bottom: 0.5px solid #e5e7eb !important;
          padding: 4px 2px !important;
          font-size: 10.5px !important;
          line-height: 1.3 !important;
          min-height: 20px !important;
          vertical-align: middle !important;
          text-align: center !important;
          color: #003361 !important;
        }

        .traders-print-content tbody tr:last-child td {
          border-bottom: none !important;
        }

        .traders-print-content tbody td span {
          color: #003361 !important;
          text-align: center !important;
        }

        .traders-print-content tbody td div {
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          min-height: 18px !important;
        }

        .traders-print-content .bg-blue-50 {
          background: rgba(0, 51, 97, 0.15) !important;
          border: 0.5px solid #003361 !important;
          border-radius: 8px !important;
          padding: 8px !important;
        }

        .traders-print-content .totals-section table {
          border: none !important;
        }

        .traders-print-content .totals-section h3 {
          font-size: 15px !important;
          font-weight: bold !important;
        }

        .traders-print-content .totals-section tbody td {
          padding: 4px 2px !important;
          text-align: center !important;
          vertical-align: middle !important;
          min-height: 20px !important;
        }

        .traders-print-content .totals-section thead th {
          padding: 8px 4px !important;
          text-align: center !important;
          vertical-align: middle !important;
        }

        .traders-print-content .traders-basic-info {
          margin-bottom: 16px !important;
        }

        .traders-print-content .traders-data-section {
          margin-bottom: 16px !important;
        }

        .traders-print-content .traders-section-title {
          margin-bottom: 16px !important;
        }

        .traders-print-content .overflow-x-auto {
          margin-bottom: 16px !important;
        }

        .traders-print-content .traders-totals-wrapper {
          margin-top: 16px !important;
        }

        .traders-print-content .traders-totals-title {
          margin-bottom: 16px !important;
        }
      }
    `;

    const oldStyles = document.getElementById('dynamic-print-styles-traders');
    if (oldStyles) oldStyles.remove();
    document.head.appendChild(printStyles);

    setTimeout(() => {
      window.print();
      setTimeout(() => {
        const container = document.getElementById('temp-print-container-traders');
        if (container) container.remove();
        const styles = document.getElementById('dynamic-print-styles-traders');
        if (styles) styles.remove();
      }, 1000);
    }, 200);
  };

  const handleSaveDataEntry = async () => {
    if (traderEntries.length === 0) {
      toast.error('يجب إضافة تاجر واحد على الأقل');
      return;
    }

    // التحقق من أن جميع الحقول المطلوبة تم ملؤها
    const hasEmptyFields = traderEntries.some(entry => {
      if (!entry.importer_name?.trim() || !entry.permit_number?.trim() || !entry.statement_number?.trim() ||
          !entry.animal_count?.trim() || !entry.animal_type?.trim() || !entry.quarantine_location?.trim()) {
        return true;
      }

      // التحقق من أن مكان الحجر المخصص تم ملؤه عند اختيار "أخرى"
      if (entry.quarantine_location === 'أخرى' && !entry.quarantine_location_custom?.trim()) {
        return true;
      }

      return false;
    });

    if (hasEmptyFields) {
      toast.error('يجب تعبئة جميع الحقول المطلوبة');
      return;
    }

    if (!selectedShipment) {
      toast.error('لم يتم تحديد الإجراء');
      return;
    }

    if (!window.electronAPI?.saveQuarantineTraders) {
      toast.error('غير متاح في المتصفح');
      return;
    }

    try {
      // حفظ البيانات في SQLite
      await window.electronAPI.saveQuarantineTraders(
        selectedShipment.procedure_number,
        traderEntries
      );

      toast.success('تم حفظ بيانات المستوردين بنجاح');
      setShowDataEntryModal(false);
    } catch (error) {
      console.error('Error saving trader data:', error);
      toast.error('حدث خطأ أثناء حفظ البيانات');
    }
  };

  const ViewModal = () => {
    if (!showViewModal || !selectedShipment) return null;

    // الحصول على الحيوانات المحجورة فقط
    const quarantinedAnimals = selectedShipment.animals?.filter(animal => animal.final_decision === 'حجر') || [];
    const totalQuarantineAnimals = quarantinedAnimals.reduce((sum, animal) => sum + parseInt(animal.animal_count || '0'), 0);

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <div className="p-8">
            <div className="flex items-center justify-between mb-6 pb-4 border-b">
              <button
                onClick={() => setShowViewModal(false)}
                className="p-2 hover:bg-gray-100 rounded-full transition-colors"
              >
                <X className="w-5 h-5" />
              </button>
              <div className="text-center">
                <h1 className="text-2xl font-bold mb-1" style={{ color: '#003361' }}>تفاصيل الإجراء المحجور</h1>
                <h2 className="text-lg font-semibold" style={{ color: '#f18700' }}>سجل الحجر البيطري</h2>
              </div>
              <div className="w-10"></div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
              <div className="bg-[#003361]/5 p-4 rounded-lg">
                <h3 className="font-bold text-[#003361] mb-3 text-right">معلومات أساسية</h3>
                <div className="space-y-2 text-right">
                  <div><span className="font-semibold">رقم الإجراء البيطري:</span> {selectedShipment.procedure_number || 'غير محدد'}</div>
                  {selectedShipment.procedure_date && (
                    <div><span className="font-semibold">التاريخ:</span> {selectedShipment.procedure_date}</div>
                  )}
                  <div><span className="font-semibold">طريقة النقل:</span> {selectedShipment.transport_method}</div>
                  <div><span className="font-semibold">بلد المنشأ:</span> {selectedShipment.origin_country}</div>
                  <div><span className="font-semibold">اسم المستورد:</span> {selectedShipment.importer_name}</div>
                  <div><span className="font-semibold">وقت الوصول:</span> {selectedShipment.arrival_time}</div>
                </div>
              </div>

              <div className="bg-[#f18700]/5 p-4 rounded-lg border-2 border-[#f18700]/30">
                <h3 className="font-bold text-[#f18700] mb-3 text-right">إحصائيات الحجر</h3>
                <div className="space-y-2 text-right">
                  <div><span className="font-semibold">عدد الحيوانات المحجورة:</span> <span className="text-[#f18700] font-bold">{totalQuarantineAnimals}</span></div>
                  <div><span className="font-semibold">عدد أنواع الحيوانات:</span> <span className="text-[#f18700] font-bold">{quarantinedAnimals.length}</span></div>
                  <div><span className="font-semibold">عدد الأطباء:</span> <span className="text-[#003361] font-bold">{selectedShipment.doctors?.length || 0}</span></div>
                </div>
              </div>
            </div>

            <div className="mb-6">
              <h3 className="font-bold text-gray-900 mb-3 text-right text-base">الحيوانات المحجورة</h3>
              <div className="space-y-2">
                {quarantinedAnimals.map((animal: any, index: number) => {
                  // دعم البيانات الجديدة (quarantine_locations) والقديمة (quarantine_location)
                  let locations: string[] = [];
                  if (animal.quarantine_locations && animal.quarantine_locations.length > 0) {
                    locations = animal.quarantine_locations;
                  } else if (animal.quarantine_location) {
                    // التوافق مع البيانات القديمة
                    locations = [animal.quarantine_location];
                  }
                  const locationDisplay = locations.length > 0
                    ? locations.map(loc => {
                        if (loc === 'حجر في الخمرة' && animal.quarantine_traders && animal.quarantine_traders.length > 0) {
                          return `${loc} (المستوردين: ${animal.quarantine_traders.join(', ')})`;
                        }
                        return loc;
                      }).join(' و ')
                    : 'غير محدد';

                  return (
                    <div key={index} className="bg-yellow-50 rounded-lg p-3 border-2 border-yellow-300">
                      <div className="grid grid-cols-2 md:grid-cols-5 gap-3 text-right text-sm">
                        <div>
                          <span className="text-gray-500 font-medium">نوع الحيوان:</span>
                          <div className="text-gray-900 font-semibold">{animal.animal_type}</div>
                        </div>
                        <div>
                          <span className="text-gray-500 font-medium">جنس الحيوان:</span>
                          <div className="text-gray-900">{animal.animal_gender}</div>
                        </div>
                        <div>
                          <span className="text-gray-500 font-medium">عدد الحيوانات:</span>
                          <div className="text-[#f18700] font-bold">{animal.animal_count}</div>
                        </div>
                        <div>
                          <span className="text-gray-500 font-medium">عدد النافق:</span>
                          <div className="text-red-600 font-bold">{animal.death_count}</div>
                        </div>
                        <div>
                          <span className="text-gray-500 font-medium">مكان الحجر:</span>
                          <div className="text-yellow-700 font-bold">
                            {locationDisplay}
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="mb-6">
              <h3 className="font-bold text-gray-900 mb-3 text-right text-base">تقرير الكشف الظاهري</h3>
              <div className="space-y-2">
                <div className="bg-gray-50 rounded-lg p-3">
                  <div className="text-right">
                    <span className="font-semibold">درجة الحرارة / الأغشية المخاطية: </span>
                    <span className={selectedShipment.temperature_status === 'طبيعية' ? 'text-green-600' : 'text-red-600'}>
                      {selectedShipment.temperature_status}
                    </span>
                    {selectedShipment.temperature_details && (
                      <p className="text-gray-700 mt-2">{selectedShipment.temperature_details}</p>
                    )}
                  </div>
                </div>

                <div className="bg-gray-50 rounded-lg p-3">
                  <div className="text-right">
                    <span className="font-semibold">أعراض مرضية "تنفسية - هضمية - بولية - تناسلية - عضلية - غدد لمفاوية": </span>
                    <span className={selectedShipment.disease_symptoms === 'لا يوجد' ? 'text-green-600' : 'text-red-600'}>
                      {selectedShipment.disease_symptoms}
                    </span>
                    {selectedShipment.disease_symptoms_details && (
                      <p className="text-gray-700 mt-2">{selectedShipment.disease_symptoms_details}</p>
                    )}
                  </div>
                </div>

                <div className="bg-gray-50 rounded-lg p-3">
                  <div className="text-right">
                    <span className="font-semibold">أعراض ظاهرية بالهيكل العظمي والمفاصل: </span>
                    <span className={selectedShipment.skeleton_symptoms === 'لا يوجد' ? 'text-green-600' : 'text-red-600'}>
                      {selectedShipment.skeleton_symptoms}
                    </span>
                    {selectedShipment.skeleton_symptoms_details && (
                      <p className="text-gray-700 mt-2">{selectedShipment.skeleton_symptoms_details}</p>
                    )}
                  </div>
                </div>

                <div className="bg-gray-50 rounded-lg p-3">
                  <div className="text-right">
                    <span className="font-semibold">أعراض مرضية على الجلد والحوافر: </span>
                    <span className={selectedShipment.skin_symptoms === 'لا يوجد' ? 'text-green-600' : 'text-red-600'}>
                      {selectedShipment.skin_symptoms}
                    </span>
                    {selectedShipment.skin_symptoms_details && (
                      <p className="text-gray-700 mt-2">{selectedShipment.skin_symptoms_details}</p>
                    )}
                  </div>
                </div>

                {selectedShipment.general_diagnosis && (
                  <div className="bg-gray-50 rounded-lg p-3">
                    <div className="text-right">
                      <span className="font-semibold">التشخيص العام حسب الكشف الظاهري:</span>
                      <p className="text-gray-700 mt-1">{selectedShipment.general_diagnosis}</p>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {selectedShipment.doctors && selectedShipment.doctors.length > 0 && (
              <div className="mb-6">
                <h3 className="font-bold text-gray-900 mb-3 text-right text-base">الأطباء</h3>
                <div className="bg-gray-50 rounded-lg p-3">
                  <div className="flex flex-wrap gap-2 justify-end">
                    {selectedShipment.doctors.map((doctor: string, index: number) => (
                      <span key={index} className="bg-white px-3 py-1 rounded-full text-sm border border-gray-200">
                        {doctor}
                      </span>
                    ))}
                  </div>
                </div>
              </div>
            )}

            <div className="mt-8 pt-6 border-t-2 border-gray-200">
              <div className="bg-yellow-50 rounded-lg p-4 text-center border-2 border-yellow-300">
                <p className="text-gray-900 font-semibold mb-2 text-sm">
                  هذا السجل خاص بالحيوانات المحجورة في ميناء جدة الإسلامي
                </p>
                <p className="text-yellow-700 font-medium mb-2 text-xs">
                  تعتبر هذه الوثيقة سرية وغير قابلة للتداول
                </p>
                <p className="text-gray-600 text-xs">
                  للملاحظات والاستفسارات التواصل مع إدارة محجر ميناء جدة الإسلامي
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#003361] mx-auto mb-4"></div>
          <p className="text-gray-600">جاري تحميل سجل الحجر...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-0 bg-slate-50 p-6">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 p-8">
          <PageHeader
            icon={Ship}
            title="سجل الحجر البيطري"
            subtitle="إدارة ومتابعة الحيوانات المحجورة"
          />

          <div className="flex flex-col sm:flex-row gap-4 mb-6">
            <div className="flex-1">
              <SearchInputWithPaste
                value={searchTerm}
                onChange={setSearchTerm}
                placeholder="ابحث برقم الإجراء، اسم المستورد، بلد المنشأ، رقم الإذن، أو رقم البيان..."
              />
            </div>
          </div>

          {filteredRecords.length === 0 ? (
            <div className="text-center py-12">
              <div className="bg-gray-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <Ship className="w-10 h-10 text-gray-400" />
              </div>
              <h3 className="text-xl font-semibold text-gray-700 mb-2">لا توجد إرساليات محجورة</h3>
              <p className="text-gray-500">لم يتم العثور على أي إرساليات تحتوي على حيوانات محجورة</p>
            </div>
          ) : (
            <div className="rounded-xl border-2 border-gray-200 shadow-sm overflow-hidden">
              <table className="w-full border-collapse">
                <thead>
                  <tr className="bg-[#f18700]/20 border-b-2 border-[#f18700]/40">
                    <th className="px-3 py-4 text-center font-bold text-[#003361] text-sm whitespace-nowrap">الإجراءات</th>
                    <th className="px-3 py-4 text-center font-bold text-[#003361] text-sm whitespace-nowrap">عدد الحيوانات المحجورة</th>
                    <th className="px-3 py-4 text-center font-bold text-[#003361] text-sm whitespace-nowrap">أنواع الحيوانات</th>
                    <th className="px-3 py-4 text-center font-bold text-[#003361] text-sm whitespace-nowrap">بلد المنشأ</th>
                    <th className="px-3 py-4 text-center font-bold text-[#003361] text-sm whitespace-nowrap">التاريخ</th>
                    <th className="px-3 py-4 text-center font-bold text-[#003361] text-sm whitespace-nowrap">اسم المستورد</th>
                    <th className="px-3 py-4 text-center font-bold text-[#003361] text-sm whitespace-nowrap">رقم الإجراء البيطري</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredRecords.map((record) => {
                    const quarantinedAnimals = record.animals?.filter(animal => animal.final_decision === 'حجر') || [];
                    const totalQuarantineAnimals = quarantinedAnimals.reduce((sum, animal) => sum + parseInt(animal.animal_count || '0'), 0);
                    const animalTypes = quarantinedAnimals.map(a => a.animal_type).join(' - ');

                    return (
                      <tr
                        key={record.id}
                        className="border-b border-gray-100 hover:bg-[#f18700]/5 transition-colors"
                      >
                        <td className="px-3 py-4">
                          <div className="flex items-center justify-center gap-2">
                            <button
                              onClick={() => handleDataEntry(record.id)}
                              className="p-2 text-blue-600 hover:text-white hover:bg-blue-600 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md"
                              title="إدخال بيانات"
                            >
                              <Edit className="w-4 h-4" />
                            </button>
                            <button
                              onClick={() => handleView(record.id)}
                              className="p-2 text-[#f18700] hover:text-white hover:bg-[#f18700] rounded-lg transition-all duration-200 shadow-sm hover:shadow-md"
                              title="معاينة التفاصيل"
                            >
                              <Eye className="w-4 h-4" />
                            </button>
                          </div>
                        </td>
                        <td className="px-3 py-4 text-center">
                          <span className="text-[#f18700] font-bold">{totalQuarantineAnimals}</span>
                        </td>
                        <td className="px-3 py-4 text-center text-sm text-gray-700">({animalTypes})</td>
                        <td className="px-3 py-4 text-center text-sm text-gray-700">{record.origin_country}</td>
                        <td className="px-3 py-4 text-center text-sm text-gray-700">{record.procedure_date || record.arrival_date || 'غير محدد'}</td>
                        <td className="px-3 py-4 text-center text-sm text-gray-700">{record.importer_name}</td>
                        <td className="px-3 py-4 text-center">
                          <div className="flex items-center justify-center gap-2">
                            <button
                              onClick={() => {
                                navigator.clipboard.writeText(record.procedure_number);
                                toast.success('تم نسخ رقم الإجراء');
                              }}
                              className="p-1.5 text-[#003361] hover:text-white hover:bg-[#003361] rounded-lg transition-all duration-200 shadow-sm hover:shadow-md"
                              title="نسخ رقم الإجراء"
                            >
                              <Copy className="w-3.5 h-3.5" />
                            </button>
                            <span className="font-bold text-[#003361]">{record.procedure_number}</span>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </div>

      {showViewModal && <ViewModal />}

      {showDataEntryModal && selectedShipment && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-8 traders-print-content">
              <div className="flex items-center justify-between mb-6 pb-4 border-b no-print">
                <button
                  onClick={() => setShowDataEntryModal(false)}
                  className="p-2 hover:bg-gray-100 rounded-full transition-colors"
                >
                  <X className="w-5 h-5" />
                </button>
                <h1 className="text-2xl font-bold text-center" style={{ color: '#003361' }}>
                  أسماء المستوردين الذين تمت الموافقة لهم بتحميل المواشي
                </h1>
                <div className="w-10"></div>
              </div>

              <div className="bg-blue-50 rounded-lg p-3 border border-blue-200 traders-basic-info">
                <h3 className="font-bold text-[#003361] mb-2 text-center text-sm">البيانات الأساسية</h3>
                <div className="grid grid-cols-5 gap-2 text-center text-xs">
                  <div>
                    <span className="text-gray-600 block">رقم الإجراء:</span>
                    <span className="font-bold text-gray-900">{selectedShipment.procedure_number}</span>
                  </div>
                  <div>
                    <span className="text-gray-600 block">التاريخ:</span>
                    <span className="font-bold text-gray-900">{selectedShipment.procedure_date || selectedShipment.arrival_date || 'غير محدد'}</span>
                  </div>
                  <div>
                    <span className="text-gray-600 block">اسم الباخرة:</span>
                    <span className="font-bold text-gray-900">{selectedShipment.transport_method}</span>
                  </div>
                  <div>
                    <span className="text-gray-600 block">بلد المنشأ:</span>
                    <span className="font-bold text-gray-900">{selectedShipment.origin_country}</span>
                  </div>
                  <div>
                    <span className="text-gray-600 block">نوع الحيوان:</span>
                    <span className="font-bold text-gray-900">
                      {selectedShipment.animals
                        ?.filter(a => a.final_decision === 'حجر')
                        .map(a => a.animal_type)
                        .join(' - ')}
                    </span>
                  </div>
                </div>
              </div>

              <div className="traders-data-section mt-4">
                <h3 className="font-bold text-gray-900 text-center text-lg traders-section-title mb-2">بيانات المستوردين</h3>
                <div className="flex justify-start mb-2">
                  <button
                    onClick={handleAddTrader}
                    className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors"
                  >
                    <Plus className="w-5 h-5" />
                    <span>إضافة مستورد</span>
                  </button>
                </div>

                {traderEntries.length === 0 ? (
                  <div className="text-center py-8 bg-gray-50 rounded-lg">
                    <p className="text-gray-500">لم يتم إضافة أي مستوردين بعد</p>
                  </div>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse table-fixed">
                      <thead>
                        <tr className="bg-[#003361]/10 border-b-2 border-[#003361]/20">
                          <th className="px-1 py-3 text-center font-bold text-[#003361] text-xs w-24 no-print">إجراءات</th>
                          <th className="px-2 py-3 text-center font-bold text-[#003361] text-xs w-48">اسم المستورد</th>
                          <th className="px-1 py-3 text-center font-bold text-[#003361] text-xs w-20">رقم الإذن</th>
                          <th className="px-1 py-3 text-center font-bold text-[#003361] text-xs w-20">رقم البيان</th>
                          <th className="px-1 py-3 text-center font-bold text-[#003361] text-xs w-24">عدد الحيوانات</th>
                          <th className="px-1 py-3 text-center font-bold text-[#003361] text-xs w-28">نوع الحيوان</th>
                          <th className="px-1 py-3 text-center font-bold text-[#003361] text-xs w-28">مكان الحجر</th>
                          <th className="px-1 py-3 text-center font-bold text-[#003361] text-xs w-32">السبب</th>
                          <th className="px-1 py-3 text-center font-bold text-[#003361] text-xs w-32">ملاحظات</th>
                        </tr>
                      </thead>
                      <tbody>
                        {traderEntries.map((entry) => (
                          <React.Fragment key={entry.id}>
                            <tr className="border-b border-gray-200 hover:bg-gray-50">
                            <td className="px-1 py-2 no-print">
                              <div className="flex items-center justify-center gap-1">
                                <button
                                  onClick={() => {
                                    setSelectedTraderForTruck(entry);
                                    setShowTruckStatementModal(true);
                                  }}
                                  className="p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                  title="بيان شاحنات متجهة إلى محجر الخمرة"
                                >
                                  <Truck className="w-4 h-4" />
                                </button>
                                <button
                                  onClick={() => {
                                    setSelectedTraderForSingleTruck(entry);
                                    setShowSingleTruckModal(true);
                                  }}
                                  className="p-1.5 text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                                  title="بيان شاحنة متجهة إلى محجر الخمرة"
                                >
                                  <FileText className="w-4 h-4" />
                                </button>
                                <button
                                  onClick={() => handleRemoveTrader(entry.id)}
                                  className="p-1.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                  title="حذف"
                                >
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              </div>
                            </td>
                            <td className="px-2 py-2">
                              <select
                                value={entry.importer_name}
                                onChange={(e) => handleTraderChange(entry.id, 'importer_name', e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-center text-sm"
                              >
                                <option value="">اختر المستورد</option>
                                {(() => {
                                  const uniqueImporters = new Set<string>();
                                  selectedShipment.animals
                                    ?.filter(animal =>
                                      animal.final_decision === 'حجر' &&
                                      animal.quarantine_locations?.includes('حجر في الخمرة') &&
                                      animal.quarantine_traders?.length > 0
                                    )
                                    .forEach(animal => {
                                      animal.quarantine_traders?.forEach(trader => {
                                        uniqueImporters.add(trader);
                                      });
                                    });
                                  return Array.from(uniqueImporters).map((importerName, idx) => (
                                    <option key={idx} value={importerName}>
                                      {importerName}
                                    </option>
                                  ));
                                })()}
                              </select>
                            </td>
                            <td className="px-1 py-2">
                              <input
                                type="text"
                                value={entry.permit_number}
                                onChange={(e) => handleTraderChange(entry.id, 'permit_number', e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-center text-sm"
                                placeholder="رقم الإذن"
                              />
                            </td>
                            <td className="px-1 py-2">
                              <input
                                type="text"
                                value={entry.statement_number}
                                onChange={(e) => handleTraderChange(entry.id, 'statement_number', e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-center text-sm"
                                placeholder="رقم البيان"
                              />
                            </td>
                            <td className="px-1 py-2">
                              <input
                                type="text"
                                value={entry.animal_count}
                                onChange={(e) => handleTraderChange(entry.id, 'animal_count', e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-center text-sm"
                                placeholder="عدد الحيوانات"
                              />
                            </td>
                            <td className="px-1 py-2">
                              <select
                                value={entry.animal_type}
                                onChange={(e) => handleTraderChange(entry.id, 'animal_type', e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-center text-sm"
                              >
                                <option value="">اختر النوع</option>
                                {selectedShipment.animals
                                  ?.filter(a => a.final_decision === 'حجر')
                                  .map((animal, idx) => (
                                    <option key={idx} value={animal.animal_type}>
                                      {animal.animal_type}
                                    </option>
                                  ))}
                              </select>
                            </td>
                            <td className="px-1 py-2">
                              {entry.quarantine_location === 'أخرى' ? (
                                <input
                                  type="text"
                                  value={entry.quarantine_location_custom || ''}
                                  onChange={(e) => handleTraderChange(entry.id, 'quarantine_location_custom', e.target.value)}
                                  className="w-full px-2 py-1 border border-gray-300 rounded text-center text-sm"
                                  placeholder="اكتب مكان الحجر..."
                                  autoFocus
                                  onBlur={(e) => {
                                    if (!e.target.value.trim()) {
                                      handleTraderChange(entry.id, 'quarantine_location', '');
                                    }
                                  }}
                                />
                              ) : (
                                <select
                                  value={entry.quarantine_location}
                                  onChange={(e) => handleTraderChange(entry.id, 'quarantine_location', e.target.value)}
                                  className="w-full px-2 py-1 border border-gray-300 rounded text-center text-sm"
                                >
                                  <option value="">اختر المكان</option>
                                  <option value="مزرعة المستورد">مزرعة المستورد</option>
                                  <option value="الخمرة">الخمرة</option>
                                  <option value="أخرى">أخرى</option>
                                </select>
                              )}
                            </td>
                              <td className="px-1 py-2">
                                {!customReasonEntry[entry.id] ? (
                                  <select
                                    value=""
                                    onChange={(e) => {
                                      if (e.target.value === 'أخرى') {
                                        setCustomReasonEntry({ ...customReasonEntry, [entry.id]: true });
                                      } else if (e.target.value) {
                                        const currentReasons = entry.reasons || [];
                                        if (!currentReasons.includes(e.target.value)) {
                                          handleTraderChange(entry.id, 'reasons', [...currentReasons, e.target.value]);
                                        }
                                      }
                                    }}
                                    className="w-full px-2 py-1 border border-gray-300 rounded text-center text-sm"
                                  >
                                    <option value="">اختر سبب...</option>
                                    {reasonOptions.filter(r => !entry.reasons?.includes(r)).map((reason) => (
                                      <option key={reason} value={reason}>
                                        {reason}
                                      </option>
                                    ))}
                                  </select>
                                ) : (
                                  <div className="flex gap-0.5 items-center">
                                    <button
                                      type="button"
                                      onClick={() => {
                                        const inputValue = customReasonInputs[entry.id] || '';
                                        if (inputValue.trim()) {
                                          const currentReasons = entry.reasons || [];
                                          handleTraderChange(entry.id, 'reasons', [...currentReasons, inputValue.trim()]);
                                          setCustomReasonInputs({ ...customReasonInputs, [entry.id]: '' });
                                          setCustomReasonEntry({ ...customReasonEntry, [entry.id]: false });
                                        }
                                      }}
                                      className="bg-green-600 text-white px-1.5 py-1 rounded hover:bg-green-700 transition-colors text-[10px] flex-shrink-0"
                                    >
                                      +
                                    </button>
                                    <input
                                      type="text"
                                      value={customReasonInputs[entry.id] || ''}
                                      onChange={(e) => setCustomReasonInputs({ ...customReasonInputs, [entry.id]: e.target.value })}
                                      className="w-20 px-1 py-1 border border-gray-300 rounded text-right text-[10px]"
                                      placeholder="اكتب..."
                                    />
                                    <button
                                      type="button"
                                      onClick={() => {
                                        setCustomReasonEntry({ ...customReasonEntry, [entry.id]: false });
                                        setCustomReasonInputs({ ...customReasonInputs, [entry.id]: '' });
                                      }}
                                      className="p-0.5 text-gray-400 hover:text-gray-600 transition-colors flex-shrink-0"
                                    >
                                      <X className="w-3 h-3" />
                                    </button>
                                  </div>
                                )}
                              </td>
                            <td className="px-1 py-2">
                              <input
                                type="text"
                                value={entry.notes || ''}
                                onChange={(e) => handleTraderChange(entry.id, 'notes', e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-center text-sm"
                                placeholder="ملاحظات..."
                              />
                            </td>
                            </tr>
                            {entry.reasons && entry.reasons.length > 0 && (
                              <tr className="bg-gray-50 border-b border-gray-200">
                                <td className="no-print"></td>
                                <td colSpan={8} className="px-2 py-1">
                                  <div className="flex flex-wrap gap-1 justify-end items-center">
                                    <span className="text-[10px] text-gray-600 font-semibold ml-2">الأسباب:</span>
                                    {entry.reasons.map((reason, idx) => (
                                      <span
                                        key={idx}
                                        className="inline-flex items-center gap-1 bg-white border border-gray-300 text-gray-700 px-1.5 py-0.5 rounded text-[10px] font-medium"
                                      >
                                        <button
                                          type="button"
                                          onClick={() => {
                                            const newReasons = entry.reasons?.filter((r, i) => i !== idx) || [];
                                            handleTraderChange(entry.id, 'reasons', newReasons);
                                          }}
                                          className="text-gray-400 hover:text-red-600 transition-colors no-print"
                                        >
                                          <X className="w-2.5 h-2.5" />
                                        </button>
                                        {reason}
                                      </span>
                                    ))}
                                  </div>
                                </td>
                              </tr>
                            )}
                          </React.Fragment>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

              {traderEntries.length > 0 && (
                <div className="traders-totals-wrapper mt-8">
                  <h3 className="font-bold text-gray-900 text-center traders-totals-title mb-6">الإجمالي</h3>
                  <div className="totals-section mb-8">
                    <table className="w-full">
                      <thead>
                        <tr className="border-b border-green-300">
                          <th className="px-3 py-2 text-center font-bold text-gray-700 text-sm">نوع الحيوان</th>
                          <th className="px-3 py-2 text-center font-bold text-gray-700 text-sm">إجمالي العدد</th>
                        </tr>
                      </thead>
                      <tbody>
                        {Array.from(
                          traderEntries.reduce((acc, entry) => {
                            if (entry.animal_type) {
                              const current = acc.get(entry.animal_type) || 0;
                              acc.set(entry.animal_type, current + parseInt(entry.animal_count || '0'));
                            }
                            return acc;
                          }, new Map<string, number>())
                        ).map(([animalType, total]) => (
                          <tr key={animalType} className="border-b border-green-200">
                            <td className="px-3 py-2 text-center font-semibold">{animalType}</td>
                            <td className="px-3 py-2 text-center font-bold text-green-700">{total}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              <div className="flex gap-3 justify-end no-print">
                <button
                  onClick={handlePrintTradersList}
                  className="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold transition-colors flex items-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                  </svg>
                  طباعة البيان
                </button>
                <button
                  onClick={() => setShowDataEntryModal(false)}
                  className="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-semibold transition-colors"
                >
                  إلغاء
                </button>
                <button
                  onClick={handleSaveDataEntry}
                  className="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold transition-colors"
                >
                  حفظ البيانات
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {showTruckStatementModal && selectedTraderForTruck && selectedShipment && (
        <TruckStatementModal
          trader={selectedTraderForTruck}
          shipment={selectedShipment}
          onClose={() => {
            setShowTruckStatementModal(false);
            setSelectedTraderForTruck(null);
          }}
        />
      )}

      {showSingleTruckModal && selectedTraderForSingleTruck && selectedShipment && (
        <SingleTruckModalWrapper
          trader={selectedTraderForSingleTruck}
          shipment={selectedShipment}
          savedData={singleTruckData[selectedTraderForSingleTruck.id]}
          onClose={() => {
            setShowSingleTruckModal(false);
            setSelectedTraderForSingleTruck(null);
          }}
          onSaveData={handleSaveSingleTruckData}
        />
      )}
    </div>
  );
}

interface TruckStatementModalProps {
  trader: TraderEntry;
  shipment: AnimalShipment;
  onClose: () => void;
}

interface TruckEntry {
  id: string;
  driver_name: string;
  plate_number: string;
  animal_count: number;
}

function TruckStatementModal({ trader, shipment, onClose }: TruckStatementModalProps) {
  const [truckEntries, setTruckEntries] = useState<TruckEntry[]>([]);

  useEffect(() => {
    const entries: TruckEntry[] = [];
    for (let i = 0; i < 20; i++) {
      entries.push({
        id: `truck-${i}`,
        driver_name: '',
        plate_number: '',
        animal_count: 0
      });
    }
    setTruckEntries(entries);
  }, []);

  const handleTruckChange = (id: string, field: keyof TruckEntry, value: string | number) => {
    setTruckEntries(prev => prev.map(entry =>
      entry.id === id ? { ...entry, [field]: value } : entry
    ));
  };

  const handlePrintTruckStatement = () => {
    const printArea = document.querySelector('.truck-statement-print-content');
    if (!printArea) {
      toast.error('خطأ في العثور على المحتوى للطباعة');
      return;
    }

    const clonedContent = printArea.cloneNode(true) as HTMLElement;
    const noPrintElements = clonedContent.querySelectorAll('button, .no-print');
    noPrintElements.forEach(el => el.remove());

    // Create table structure with repeating header
    const printTable = document.createElement('table');
    printTable.style.width = '100%';
    printTable.style.borderCollapse = 'collapse';

    // Create thead (will repeat on every page)
    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr>
        <th style="padding: 0;">
          <div style="text-align: center; padding: 6px 0; margin-bottom: 6px; border-bottom: 2px solid #008a40;">
            <h1 style="color: #003361 !important; font-size: 15px; font-weight: bold; margin: 0 0 2px 0;">القسم البيطري بمحجر ميناء جدة الإسلامي</h1>
            <h2 style="color: #00a651 !important; font-size: 13px; font-weight: 600; margin: 0;">بيان شاحنات متجهة إلى محجر الخمرة</h2>
            <div style="border: 1px solid #e5e7eb; border-radius: 4px; padding: 4px 0; margin-top: 4px; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 8px;">
              <div style="font-size: 7px; display: flex; align-items: center; gap: 3px;"><span style="font-weight: 700; color: #6b7280;">رقم الإجراء:</span> <span style="font-weight: 600; color: #111827;">${shipment.procedure_number || 'غير محدد'}</span></div>
              <div style="font-size: 7px; display: flex; align-items: center; gap: 3px;"><span style="font-weight: 700; color: #6b7280;">اسم المستورد:</span> <span style="font-weight: 600; color: #111827;">${trader.importer_name}</span></div>
              <div style="font-size: 7px; display: flex; align-items: center; gap: 3px;"><span style="font-weight: 700; color: #6b7280;">التاريخ:</span> <span style="font-weight: 600; color: #111827;">${shipment.procedure_date || shipment.arrival_date || new Date().toLocaleDateString('en-GB')}</span></div>
              <div style="font-size: 7px; display: flex; align-items: center; gap: 3px;"><span style="font-weight: 700; color: #6b7280;">بلد المنشأ:</span> <span style="font-weight: 600; color: #111827;">${shipment.origin_country || 'غير محدد'}</span></div>
            </div>
          </div>
        </th>
      </tr>
    `;

    // Create tbody with content
    const tbody = document.createElement('tbody');
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.style.padding = '0';
    td.appendChild(clonedContent);
    tr.appendChild(td);
    tbody.appendChild(tr);

    printTable.appendChild(thead);
    printTable.appendChild(tbody);

    const printContainer = document.createElement('div');
    printContainer.id = 'temp-print-container-truck';
    printContainer.style.display = 'none';
    printContainer.appendChild(printTable);
    document.body.appendChild(printContainer);

    const printStyles = document.createElement('style');
    printStyles.id = 'dynamic-print-styles-truck';
    printStyles.textContent = `
      @media print {
        @page {
          size: A4 portrait;
          margin: 10mm !important;
        }
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          color-adjust: exact !important;
        }

        body {
          background: white !important;
          margin: 0 !important;
          padding: 0 !important;
        }

        table {
          width: 100% !important;
          border-collapse: collapse !important;
        }

        thead {
          display: table-header-group !important;
        }

        tbody {
          display: table-row-group !important;
        }

        th, td {
          page-break-inside: avoid !important;
        }

        body::after {
          content: "هذا البيان تم إنشاءه لاستخدامات القسم البيطري بمحجر ميناء جدة الإسلامي • تعتبر هذه الوثيقة سرية وغير قابلة للتداول ويعرضك تداولها أو تصويرها للمسائلة القانونية • للملاحظات والاستفسارات التواصل مع إدارة محجر ميناء جدة الإسلامي" !important;
          position: fixed !important;
          bottom: 0 !important;
          left: 0 !important;
          right: 0 !important;
          width: 100% !important;
          text-align: center !important;
          font-size: 6.5px !important;
          padding: 8px 10px !important;
          background: white !important;
          border-top: 2px solid #008a40 !important;
          color: #374151 !important;
          font-weight: 600 !important;
          line-height: 1.3 !important;
          z-index: 9999 !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        body > *:not(#temp-print-container-truck) {
          display: none !important;
        }

        #temp-print-container-truck {
          display: block !important;
          position: static !important;
          background: white !important;
          padding: 0 !important;
          margin: 0 !important;
          width: 100% !important;
          box-sizing: border-box !important;
        }

        #temp-print-container-truck > * {
          margin: 0 !important;
          padding: 0 !important;
        }

        #temp-print-container-truck * {
          visibility: visible !important;
        }

        .no-print,
        button,
        svg {
          display: none !important;
        }
        input {
          display: none !important;
        }

        h1, h2, h3 {
          page-break-after: avoid !important;
        }

        h1 { color: #003361 !important; }
        h2 { color: #00a651 !important; }
        h3 { color: #6b7280 !important; }

        .text-gray-900 { color: #111827 !important; }
        .text-gray-700 { color: #374151 !important; }
        .text-gray-600 { color: #4b5563 !important; }
        .text-gray-500 { color: #6b7280 !important; }

        .truck-statement-print-content {
          padding: 0 !important;
          margin: 0 !important;
        }

        .truck-statement-print-content > div {
          page-break-inside: auto !important;
        }

        .truck-statement-print-content .bg-blue-50 {
          background: rgba(0, 51, 97, 0.15) !important;
          border: 0.5px solid #003361 !important;
          border-radius: 8px !important;
          padding: 12px !important;
          margin-bottom: 10px !important;
          display: flex !important;
          flex-direction: column !important;
          justify-content: center !important;
          min-height: 70px !important;
        }

        .truck-statement-print-content .bg-blue-50 h3 {
          margin: 0 0 10px 0 !important;
          padding: 0 !important;
          font-size: 11px !important;
        }

        .truck-statement-print-content .bg-blue-50 .grid {
          display: grid !important;
          grid-template-columns: repeat(4, 1fr) !important;
          gap: 12px !important;
          align-items: start !important;
          justify-content: center !important;
          margin: 0 !important;
        }

        .truck-statement-print-content .bg-blue-50 .grid > div {
          padding: 4px 0 !important;
        }

        .truck-statement-print-content .bg-blue-50 .grid span.block {
          display: block !important;
          margin-bottom: 3px !important;
          font-size: 8px !important;
        }

        .truck-statement-print-content .bg-blue-50 .grid span.font-bold {
          font-size: 9px !important;
          line-height: 1.3 !important;
        }

        .truck-statement-print-content .bg-amber-50 {
          background: #fffbeb !important;
          border: 0.5px solid #f59e0b !important;
          border-radius: 8px !important;
          padding: 10px !important;
          margin-bottom: 12px !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          min-height: 40px !important;
        }

        .truck-statement-print-content .truck-data-section {
          margin-top: 12px !important;
        }

        .truck-statement-print-content .truck-data-section h3 {
          background: #f5f5f5 !important;
          border: 0.5px solid #003361 !important;
          border-radius: 8px !important;
          padding: 10px !important;
          margin: 0 0 12px 0 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          min-height: 40px !important;
        }

        .truck-statement-print-content .overflow-x-auto {
          margin-top: 12px !important;
        }

        .truck-statement-print-content table {
          width: 100% !important;
          border-collapse: separate !important;
          border-spacing: 0 !important;
          border: none !important;
          overflow: hidden !important;
        }

        .truck-statement-print-content thead th {
          background: #f5f5f5 !important;
          color: #003361 !important;
          border: none !important;
          border-bottom: 1px solid #e5e7eb !important;
          padding: 8px 4px !important;
          font-size: 11px !important;
          font-weight: bold !important;
          line-height: 1.3 !important;
          height: 32px !important;
          vertical-align: middle !important;
          text-align: center !important;
        }

        .truck-statement-print-content tbody tr {
          height: 26px !important;
        }

        .truck-statement-print-content tbody tr:nth-child(even) {
          background: linear-gradient(to right, #f8fafc 0%, #f1f5f9 100%) !important;
        }

        .truck-statement-print-content tbody tr:nth-child(odd) {
          background: white !important;
        }

        .truck-statement-print-content tbody td {
          border: none !important;
          border-bottom: 0.5px solid #e5e7eb !important;
          padding: 8px 4px !important;
          font-size: 10.5px !important;
          line-height: 1.4 !important;
          height: 26px !important;
          vertical-align: middle !important;
          text-align: center !important;
          color: #003361 !important;
        }

        .truck-statement-print-content tbody tr:last-child td {
          border-bottom: none !important;
        }

        .truck-statement-print-content tbody td span {
          color: #003361 !important;
        }
      }
    `;

    const oldStyles = document.getElementById('dynamic-print-styles-truck');
    if (oldStyles) oldStyles.remove();
    document.head.appendChild(printStyles);

    setTimeout(() => {
      window.print();
      setTimeout(() => {
        const container = document.getElementById('temp-print-container-truck');
        if (container) container.remove();
        const styles = document.getElementById('dynamic-print-styles-truck');
        if (styles) styles.remove();
      }, 1000);
    }, 200);
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
        <div className="bg-gradient-to-r from-[#003361] to-[#004280] p-6 flex justify-between items-center no-print">
          <button onClick={onClose} className="text-white hover:bg-white/20 p-2 rounded-lg transition-colors">
            <X className="w-6 h-6" />
          </button>
          <h2 className="text-2xl font-bold text-white">بيان شاحنات متجهة إلى محجر الخمرة</h2>
          <div className="w-10"></div>
        </div>

        <div className="flex-1 overflow-y-auto p-6 truck-statement-print-content">
          <div className="text-center mb-4 no-print">
            <h2 className="text-xl font-bold text-[#003361]">بيان شاحنات متجهة إلى محجر الخمرة</h2>
          </div>
          <div className="bg-blue-50 rounded-lg p-3 mb-4 border border-blue-200">
            <h3 className="text-sm font-bold text-[#003361] mb-2 text-center">البيانات الأساسية</h3>
            <div className="grid grid-cols-4 gap-2 text-xs text-center">
              <div>
                <span className="text-gray-600 block">اسم الباخرة:</span>
                <span className="font-bold text-gray-900">{shipment.transport_method || 'غير محدد'}</span>
              </div>
              <div>
                <span className="text-gray-600 block">رقم الإجراء:</span>
                <span className="font-bold text-gray-900">{shipment.procedure_number}</span>
              </div>
              <div>
                <span className="text-gray-600 block">وقت الوصول:</span>
                <span className="font-bold text-gray-900">{shipment.arrival_time}</span>
              </div>
              <div>
                <span className="text-gray-600 block">اسم المستورد:</span>
                <span className="font-bold text-gray-900">{trader.importer_name}</span>
              </div>
              <div>
                <span className="text-gray-600 block">بلد المنشأ:</span>
                <span className="font-bold text-gray-900">{shipment.origin_country}</span>
              </div>
              <div>
                <span className="text-gray-600 block">عدد ونوع الحيوانات:</span>
                <span className="font-bold text-gray-900">{trader.animal_count} - {trader.animal_type}</span>
              </div>
              <div>
                <span className="text-gray-600 block">التاريخ:</span>
                <span className="font-bold text-gray-900">{shipment.procedure_date || shipment.arrival_date || new Date().toLocaleDateString('en-GB')}</span>
              </div>
            </div>
          </div>

          {trader.reasons && trader.reasons.length > 0 && (
            <div className="bg-amber-50 rounded-xl p-4 mb-6 border-2 border-amber-200">
              <div className="flex items-center gap-3">
                <span className="font-bold text-[#003361]">السبب:</span>
                <span className="font-semibold text-gray-900">{trader.reasons.join(' - ')}</span>
              </div>
            </div>
          )}

          <div className="truck-data-section">
            <h3 className="text-lg font-bold text-[#003361] bg-gray-50 p-4 border-b-2 border-gray-200 text-center">بيانات الشاحنات</h3>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="bg-[#003361]/10 border-b-2 border-[#003361]/20">
                    <th className="px-4 py-3 text-center font-bold text-[#003361] text-sm w-20">الرقم</th>
                    <th className="px-4 py-3 text-center font-bold text-[#003361] text-sm">اسم السائق</th>
                    <th className="px-4 py-3 text-center font-bold text-[#003361] text-sm">رقم اللوحة</th>
                    <th className="px-4 py-3 text-center font-bold text-[#003361] text-sm w-32">عدد الحيوانات</th>
                  </tr>
                </thead>
                <tbody>
                  {Array.from({ length: 15 }).map((_, index) => {
                    const entry = truckEntries[index];
                    return (
                      <tr key={entry?.id || `empty-${index}`} className="border-b border-gray-200 hover:bg-gray-50">
                        <td className="px-4 py-3 text-center font-semibold">{index + 1}</td>
                        <td className="px-4 py-3">
                          <input
                            type="text"
                            value={entry?.driver_name || ''}
                            onChange={(e) => entry && handleTruckChange(entry.id, 'driver_name', e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-center"
                            placeholder="اسم السائق"
                            disabled={!entry}
                          />
                        </td>
                        <td className="px-4 py-3">
                          <input
                            type="text"
                            value={entry?.plate_number || ''}
                            onChange={(e) => entry && handleTruckChange(entry.id, 'plate_number', e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-center"
                            placeholder="رقم اللوحة"
                            disabled={!entry}
                          />
                        </td>
                        <td className="px-4 py-3">
                          <input
                            type="number"
                            value={entry?.animal_count || ''}
                            onChange={(e) => entry && handleTruckChange(entry.id, 'animal_count', parseInt(e.target.value) || 0)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-center"
                            placeholder="عدد الحيوانات"
                            min="0"
                            disabled={!entry}
                          />
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>

            {/* Footer section with signature */}
            <div className="mt-8 flex justify-center">
              <div className="text-center">
                <p className="vet-signature text-gray-900 font-semibold text-lg mb-20"></p>
              </div>
            </div>
          </div>
        </div>

        <div className="border-t p-6 bg-gray-50 flex gap-3 justify-end no-print">
          <button
            onClick={handlePrintTruckStatement}
            className="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold transition-colors flex items-center gap-2"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            طباعة البيان
          </button>
          <button
            onClick={onClose}
            className="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-semibold transition-colors"
          >
            إغلاق
          </button>
        </div>
      </div>
    </div>
  );
}

interface SingleTruckModalWrapperProps {
  trader: TraderEntry;
  shipment: AnimalShipment;
  onClose: () => void;
  savedData?: {driverName: string; plateNumber: string; departureDateTime: string; trucksCount: string; animalCount: string; animalType: string;};
  onSaveData: (traderId: string, data: {driverName: string; plateNumber: string; departureDateTime: string; trucksCount: string; animalCount: string; animalType: string;}) => void;
}

function SingleTruckModalWrapper({ trader, shipment, onClose, savedData, onSaveData }: SingleTruckModalWrapperProps) {
  const handleSaveData = useCallback((data: {driverName: string; plateNumber: string; departureDateTime: string; trucksCount: string; animalCount: string; animalType: string;}) => {
    onSaveData(trader.id, data);
  }, [trader.id, onSaveData]);

  return (
    <SingleTruckStatementModal
      trader={trader}
      shipment={shipment}
      onClose={onClose}
      savedData={savedData}
      onSaveData={handleSaveData}
    />
  );
}

interface SingleTruckStatementModalProps {
  trader: TraderEntry;
  shipment: AnimalShipment;
  onClose: () => void;
  savedData?: {driverName: string; plateNumber: string; departureDateTime: string; trucksCount: string; animalCount: string; animalType: string;};
  onSaveData: (data: {driverName: string; plateNumber: string; departureDateTime: string; trucksCount: string; animalCount: string; animalType: string;}) => void;
}

function SingleTruckStatementModal({ trader, shipment, onClose, savedData, onSaveData }: SingleTruckStatementModalProps) {
  const [driverName, setDriverName] = useState(savedData?.driverName || '');
  const [plateNumber, setPlateNumber] = useState(savedData?.plateNumber || '');
  const [departureDateTime, setDepartureDateTime] = useState(savedData?.departureDateTime || '');
  const [trucksCount, setTrucksCount] = useState(savedData?.trucksCount || '');
  const [animalCount, setAnimalCount] = useState(savedData?.animalCount || trader.animal_count || '');
  const [animalType, setAnimalType] = useState(savedData?.animalType || trader.animal_type || '');

  useEffect(() => {
    if (!savedData) {
      setAnimalCount(trader.animal_count || '');
      setAnimalType(trader.animal_type || '');
    }
  }, [trader.animal_count, trader.animal_type, savedData]);

  useEffect(() => {
    onSaveData({
      driverName,
      plateNumber,
      departureDateTime,
      trucksCount,
      animalCount,
      animalType
    });
  }, [driverName, plateNumber, departureDateTime, trucksCount, animalCount, animalType]);

  const handlePrintSingleTruck = () => {
    const printArea = document.querySelector('.single-truck-print-content');
    if (!printArea) {
      toast.error('خطأ في العثور على المحتوى للطباعة');
      return;
    }

    const originalInputs = printArea.querySelectorAll('input[type="text"], input[type="number"]');
    const inputValues: string[] = [];
    originalInputs.forEach((input) => {
      const inputEl = input as HTMLInputElement;
      inputValues.push(inputEl.value || '');
    });

    const clonedContent = printArea.cloneNode(true) as HTMLElement;

    const clonedInputs = clonedContent.querySelectorAll('input[type="text"], input[type="number"]');
    clonedInputs.forEach((input, index) => {
      if (inputValues[index] !== undefined) {
        const span = document.createElement('span');
        span.textContent = inputValues[index];
        span.style.cssText = 'display: block; text-align: center; padding: 8px; font-size: 11px; line-height: 1.3; color: #111827; font-weight: 600;';
        input.parentNode?.replaceChild(span, input);
      }
    });

    const noPrintElements = clonedContent.querySelectorAll('button, .no-print');
    noPrintElements.forEach(el => el.remove());

    // Create table structure with repeating header
    const printTable = document.createElement('table');
    printTable.style.width = '100%';
    printTable.style.borderCollapse = 'collapse';

    // Create thead (will repeat on every page)
    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr>
        <th style="padding: 0;">
          <div style="text-align: center; padding: 6px 0; margin-bottom: 6px; border-bottom: 2px solid #008a40;">
            <h1 style="color: #003361 !important; font-size: 15px; font-weight: bold; margin: 0 0 2px 0;">القسم البيطري بمحجر ميناء جدة الإسلامي</h1>
            <h2 style="color: #00a651 !important; font-size: 13px; font-weight: 600; margin: 0;">بيان شاحنة متجهة إلى محجر الخمرة</h2>
            <div style="border: 1px solid #e5e7eb; border-radius: 4px; padding: 4px 0; margin-top: 4px; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 8px;">
              <div style="font-size: 7px; display: flex; align-items: center; gap: 3px;"><span style="font-weight: 700; color: #6b7280;">رقم الإجراء:</span> <span style="font-weight: 600; color: #111827;">${shipment.procedure_number || 'غير محدد'}</span></div>
              <div style="font-size: 7px; display: flex; align-items: center; gap: 3px;"><span style="font-weight: 700; color: #6b7280;">اسم المستورد:</span> <span style="font-weight: 600; color: #111827;">${trader.importer_name}</span></div>
              <div style="font-size: 7px; display: flex; align-items: center; gap: 3px;"><span style="font-weight: 700; color: #6b7280;">التاريخ:</span> <span style="font-weight: 600; color: #111827;">${shipment.procedure_date || shipment.arrival_date || new Date().toLocaleDateString('en-GB')}</span></div>
              <div style="font-size: 7px; display: flex; align-items: center; gap: 3px;"><span style="font-weight: 700; color: #6b7280;">بلد المنشأ:</span> <span style="font-weight: 600; color: #111827;">${shipment.origin_country || 'غير محدد'}</span></div>
            </div>
          </div>
        </th>
      </tr>
    `;

    // Create tbody with content
    const tbody = document.createElement('tbody');
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.style.padding = '0';
    td.appendChild(clonedContent);
    tr.appendChild(td);
    tbody.appendChild(tr);

    printTable.appendChild(thead);
    printTable.appendChild(tbody);

    const printContainer = document.createElement('div');
    printContainer.id = 'temp-print-container-single';
    printContainer.style.display = 'none';
    printContainer.appendChild(printTable);
    document.body.appendChild(printContainer);

    const printStyles = document.createElement('style');
    printStyles.id = 'dynamic-print-styles-single';
    printStyles.textContent = `
      @media print {
        @page {
          size: A4 portrait;
          margin: 10mm !important;
        }
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          color-adjust: exact !important;
        }

        body {
          background: white !important;
          margin: 0 !important;
          padding: 0 !important;
        }

        table {
          width: 100% !important;
          border-collapse: collapse !important;
        }

        thead {
          display: table-header-group !important;
        }

        tbody {
          display: table-row-group !important;
        }

        th, td {
          page-break-inside: avoid !important;
        }

        body::after {
          content: "هذا البيان تم إنشاءه لاستخدامات القسم البيطري بمحجر ميناء جدة الإسلامي • تعتبر هذه الوثيقة سرية وغير قابلة للتداول ويعرضك تداولها أو تصويرها للمسائلة القانونية • للملاحظات والاستفسارات التواصل مع إدارة محجر ميناء جدة الإسلامي" !important;
          position: fixed !important;
          bottom: 0 !important;
          left: 0 !important;
          right: 0 !important;
          width: 100% !important;
          text-align: center !important;
          font-size: 6.5px !important;
          padding: 8px 10px !important;
          background: white !important;
          border-top: 2px solid #008a40 !important;
          color: #374151 !important;
          font-weight: 600 !important;
          line-height: 1.3 !important;
          z-index: 9999 !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        body > *:not(#temp-print-container-single) {
          display: none !important;
        }

        #temp-print-container-single {
          display: block !important;
          position: static !important;
          background: white !important;
          padding: 0 !important;
          margin: 0 !important;
          width: 100% !important;
          box-sizing: border-box !important;
        }

        #temp-print-container-single > * {
          margin: 0 !important;
          padding: 0 !important;
        }

        #temp-print-container-single * {
          visibility: visible !important;
        }

        .no-print,
        button,
        svg {
          display: none !important;
        }
        input {
          display: none !important;
        }

        h1, h2, h3 {
          page-break-after: avoid !important;
        }

        h1 { color: #003361 !important; }
        h2 { color: #00a651 !important; }
        h3 { color: #6b7280 !important; }

        .text-gray-900 { color: #111827 !important; }
        .text-gray-700 { color: #374151 !important; }
        .text-gray-600 { color: #4b5563 !important; }
        .text-gray-500 { color: #6b7280 !important; }

        .single-truck-print-content {
          padding: 0 !important;
          margin: 0 !important;
        }

        .single-truck-print-content > div {
          page-break-inside: auto !important;
        }

        .single-truck-print-content .bg-blue-50 {
          background: rgba(0, 51, 97, 0.15) !important;
          border: 0.5px solid #003361 !important;
          border-radius: 8px !important;
          padding: 12px !important;
          margin-bottom: 10px !important;
          display: flex !important;
          flex-direction: column !important;
          justify-content: center !important;
          min-height: 70px !important;
        }

        .single-truck-print-content .bg-blue-50 h3 {
          margin: 0 0 10px 0 !important;
          padding: 0 !important;
          font-size: 11px !important;
        }

        .single-truck-print-content .bg-blue-50 .grid {
          display: grid !important;
          grid-template-columns: repeat(4, 1fr) !important;
          gap: 12px !important;
          align-items: start !important;
          justify-content: center !important;
          margin: 0 !important;
        }

        .single-truck-print-content .bg-blue-50 .grid > div {
          padding: 4px 0 !important;
        }

        .single-truck-print-content .bg-blue-50 .grid span.block {
          display: block !important;
          margin-bottom: 3px !important;
          font-size: 8px !important;
        }

        .single-truck-print-content .bg-blue-50 .grid span.font-bold {
          font-size: 9px !important;
          line-height: 1.3 !important;
        }

        .single-truck-print-content .single-truck-data-section {
          margin-top: 8px !important;
        }

        .single-truck-print-content .single-truck-data-section h3 {
          background: #f5f5f5 !important;
          border: 0.5px solid #d1d5db !important;
          border-radius: 8px !important;
          padding: 10px !important;
          margin: 0 0 8px 0 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          min-height: 40px !important;
        }

        .single-truck-print-content .single-truck-data-section .p-6 {
          padding: 0 !important;
          margin-top: 12px !important;
        }

        .single-truck-print-content table {
          width: 100% !important;
          border-collapse: separate !important;
          border-spacing: 0 !important;
          border: none !important;
          overflow: hidden !important;
        }

        .single-truck-print-content tbody tr {
          height: 50px !important;
          min-height: 50px !important;
          max-height: 50px !important;
        }

        .single-truck-print-content tbody td {
          background: white !important;
          border: none !important;
          border-bottom: 0.5px solid #e5e7eb !important;
          padding: 0 8px !important;
          font-size: 11px !important;
          line-height: 1.3 !important;
          text-align: center !important;
          vertical-align: middle !important;
          height: 50px !important;
          display: table-cell !important;
        }

        .single-truck-print-content tbody td:first-child {
          background: #f5f5f5 !important;
          color: #003361 !important;
          font-weight: bold !important;
          width: 35% !important;
        }

        .single-truck-print-content tbody td:last-child {
          color: #111827 !important;
          font-weight: 600 !important;
        }

        .single-truck-print-content tbody td span {
          display: inline-block !important;
          vertical-align: middle !important;
          text-align: center !important;
          width: 100% !important;
        }

        .single-truck-print-content tbody tr:first-child td {
          border-top: none !important;
        }

        .single-truck-print-content tbody tr:last-child td {
          border-bottom: none !important;
        }

        .single-truck-print-content .mt-12 {
          margin-top: 48px !important;
          page-break-inside: avoid !important;
        }

        .single-truck-print-content .mt-12 .text-right {
          text-align: right !important;
          display: block !important;
        }

        .single-truck-print-content .mt-12 p {
          font-size: 13px !important;
          font-weight: bold !important;
          color: #003361 !important;
          margin-bottom: 4px !important;
          text-align: right !important;
        }

        .single-truck-print-content .mt-12 .h-20 {
          height: 80px !important;
          width: 256px !important;
          margin-right: 0 !important;
          margin-left: auto !important;
        }
      }
    `;

    const oldStyles = document.getElementById('dynamic-print-styles-single');
    if (oldStyles) oldStyles.remove();
    document.head.appendChild(printStyles);

    setTimeout(() => {
      window.print();
      setTimeout(() => {
        const container = document.getElementById('temp-print-container-single');
        if (container) container.remove();
        const styles = document.getElementById('dynamic-print-styles-single');
        if (styles) styles.remove();
      }, 1000);
    }, 200);
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <div className="bg-gradient-to-r from-[#003361] to-[#004280] p-6 flex justify-between items-center no-print">
          <button onClick={onClose} className="text-white hover:bg-white/20 p-2 rounded-lg transition-colors">
            <X className="w-6 h-6" />
          </button>
          <h2 className="text-2xl font-bold text-white">بيان شاحنة متجهة إلى محجر الخمرة</h2>
          <div className="w-10"></div>
        </div>

        <div className="flex-1 overflow-y-auto p-6 single-truck-print-content">
          <div className="text-center mb-4 no-print">
            <h2 className="text-xl font-bold text-[#003361]">بيان شاحنة متجهة إلى محجر الخمرة</h2>
          </div>
          <div className="bg-blue-50 rounded-lg p-4 mb-4 border border-blue-200">
            <h3 className="text-sm font-bold text-[#003361] mb-3 text-center">البيانات الأساسية</h3>
            <div className="grid grid-cols-4 gap-4 text-xs text-center">
              <div className="py-2">
                <span className="text-gray-600 block mb-1">اسم الباخرة:</span>
                <span className="font-bold text-gray-900">{shipment.transport_method || 'غير محدد'}</span>
              </div>
              <div className="py-2">
                <span className="text-gray-600 block mb-1">رقم الإجراء:</span>
                <span className="font-bold text-gray-900">{shipment.procedure_number}</span>
              </div>
              <div className="py-2">
                <span className="text-gray-600 block mb-1">وقت الوصول:</span>
                <span className="font-bold text-gray-900">{shipment.arrival_time}</span>
              </div>
              <div className="py-2">
                <span className="text-gray-600 block mb-1">اسم المستورد:</span>
                <span className="font-bold text-gray-900">{trader.importer_name}</span>
              </div>
              <div className="py-2">
                <span className="text-gray-600 block mb-1">بلد المنشأ:</span>
                <span className="font-bold text-gray-900">{shipment.origin_country}</span>
              </div>
              <div className="py-2">
                <span className="text-gray-600 block mb-1">عدد ونوع الحيوانات:</span>
                <span className="font-bold text-gray-900">{animalCount || trader.animal_count} - {animalType || trader.animal_type}</span>
              </div>
              <div className="py-2">
                <span className="text-gray-600 block mb-1">التاريخ:</span>
                <span className="font-bold text-gray-900">{shipment.procedure_date || shipment.arrival_date || new Date().toLocaleDateString('en-GB')}</span>
              </div>
            </div>
          </div>

          <div className="single-truck-data-section">
            <h3 className="text-lg font-bold text-[#003361] bg-gray-50 p-4 border-b-2 border-gray-200 text-center">بيانات الشاحنة</h3>
            <div className="p-6">
              <table className="w-full">
                <tbody>
                  <tr className="border-b border-gray-200">
                    <td className="py-4 px-4 font-bold text-[#003361] text-center bg-[#003361]/10 w-1/3">اسم السائق</td>
                    <td className="py-4 px-4">
                      <input
                        type="text"
                        value={driverName}
                        onChange={(e) => setDriverName(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-center"
                        placeholder="أدخل اسم السائق"
                      />
                    </td>
                  </tr>
                  <tr className="border-b border-gray-200">
                    <td className="py-4 px-4 font-bold text-[#003361] text-center bg-[#003361]/10 w-1/3">رقم اللوحة</td>
                    <td className="py-4 px-4">
                      <input
                        type="text"
                        value={plateNumber}
                        onChange={(e) => setPlateNumber(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-center"
                        placeholder="أدخل رقم اللوحة"
                      />
                    </td>
                  </tr>
                  <tr className="border-b border-gray-200">
                    <td className="py-4 px-4 font-bold text-[#003361] text-center bg-[#003361]/10 w-1/3">عدد الحيوانات</td>
                    <td className="py-4 px-4">
                      <input
                        type="text"
                        value={animalCount}
                        onChange={(e) => setAnimalCount(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-center"
                        placeholder="أدخل عدد الحيوانات"
                      />
                    </td>
                  </tr>
                  <tr className="border-b border-gray-200">
                    <td className="py-4 px-4 font-bold text-[#003361] text-center bg-[#003361]/10 w-1/3">نوع الحيوان</td>
                    <td className="py-4 px-4">
                      <input
                        type="text"
                        value={animalType}
                        onChange={(e) => setAnimalType(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-center"
                        placeholder="أدخل نوع الحيوان"
                      />
                    </td>
                  </tr>
                  <tr className="border-b border-gray-200">
                    <td className="py-4 px-4 font-bold text-[#003361] text-center bg-[#003361]/10 w-1/3">وقت وتاريخ مغادرة الميناء</td>
                    <td className="py-4 px-4">
                      <input
                        type="text"
                        value={departureDateTime}
                        onChange={(e) => setDepartureDateTime(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-center"
                        placeholder="أدخل الوقت والتاريخ"
                      />
                    </td>
                  </tr>
                  <tr className="border-b border-gray-200">
                    <td className="py-4 px-4 font-bold text-[#003361] text-center bg-[#003361]/10 w-1/3">عدد الشاحنات المرسلة</td>
                    <td className="py-4 px-4">
                      <input
                        type="number"
                        value={trucksCount}
                        onChange={(e) => setTrucksCount(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-center"
                        placeholder="أدخل عدد الشاحنات"
                        min="1"
                      />
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            {/* Footer section with signature */}
            <div className="mt-12 flex justify-end">
              <div className="text-right">
                <p className="text-gray-900 font-bold text-base mb-1">طبيب القسم البيطري بمحجر ميناء جدة الإسلامي</p>
                <div className="h-20 w-64"></div>
              </div>
            </div>
          </div>
        </div>

        <div className="border-t p-6 bg-gray-50 flex gap-3 justify-end no-print">
          <button
            onClick={handlePrintSingleTruck}
            className="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold transition-colors flex items-center gap-2"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            طباعة البيان
          </button>
          <button
            onClick={onClose}
            className="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-semibold transition-colors"
          >
            إغلاق
          </button>
        </div>
      </div>
    </div>
  );
}
